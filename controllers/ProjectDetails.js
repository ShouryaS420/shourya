import mongoose from 'mongoose';
import Project from '../models/ProjectDetails.js';
import User from '../models/User.js';
import VendorUsers from '../models/VendorUsers.js';
import { sendmail } from '../utils/sendmail.js';
import { logActivity } from '../utils/logActivity.js';
import PDFDocument from "pdfkit";
import fs from "fs";
import path from "path";
import { sendMailWithAttachments } from '../utils/sendmailWithAttachments.js';
import { newId } from '../utils/id.js';
import EmailEvent from '../models/EmailEvent.js';

function generateProjectId() {
    const prefix = "PRJ";
    const randomNumber = Math.floor(Math.random() * 10000000); // Generates a random number
    return `${prefix}${randomNumber.toString().padStart(7, '0')}`; // Ensures the number is 7 digits long
}

const predefinedSteps = [
    {
        title: "Initial Contact",
        description: "First interaction with the client to discuss their needs and introduce our services.",
        status: "completed",
        subSteps: []
    },
    {
        title: "Site visit & feasibility study",
        description: "Evaluation of the site to assess feasibility and discuss potential project scope with the client.",
        status: "completed",
        subSteps: []
    },
    {
        title: "Design & consultation",
        description: "Collaborative design sessions with the client to finalize the project specifications and materials.",
        status: "completed",
        subSteps: [
            { title: "Meeting with design team", description: "Discuss initial design concepts and gather client feedback.", status: "completed" },
            { title: "Initial concept design & layout presentation", description: "Presentation of initial design layouts and concept boards to the client.", status: "completed" },
            { title: "Material & finishing discussion", description: "Finalize materials and finishes based on client preferences and budget.", status: "completed" },
        ]
    },
    {
        title: "Package selection & customization",
        description: "Selection of construction packages and customization options based on client preferences.",
        status: "ongoing-stage",
        subSteps: [
            { title: "Standard package selection", description: "Choose from standard construction packages tailored to client needs.", status: "" },
            { title: "Add-ons customization", description: "Customize additional features and enhancements.", status: "" },
            // { title: "Autogenerated BOQs", description: "Generate detailed Bill of Quantities for accurate pricing.", status: "" },
            // { title: "Final cost estimation", description: "Provide final cost estimates after all selections and customizations are made.", status: "" },
        ],
    },
    {
        title: "Agreement & booking payment",
        description: "Finalize agreement details and process the booking payment to secure the project commencement.",
        status: "",
        subSteps: [
            { title: "Initial payment received", description: "Confirm receipt of initial booking payment as per the agreement.", status: "" },
            { title: "Contract sign-in", description: "Sign official project contract with the client.", status: "" },
        ],
    },
    {
        title: "Pre-construction Readiness",
        description: "Complete all pre-construction requirements and readiness checks to ensure a smooth project start.",
        status: "",
        subSteps: [
            { title: "Legal and plan liationing", description: "Handle all legal paperwork and liaise with planning authorities.", status: "" },
            { title: "Soil Testing", description: "Conduct soil testing to inform foundation strategies.", status: "" },
            { title: "Digital Survey", description: "Perform a digital survey to capture detailed site conditions.", status: "" },
            { title: "Plan approval before main drawing", description: "Secure approvals for the preliminary plans before proceeding to detailed drawings.", status: "" },
        ],
    },
    {
        title: "Final design & structural drawings",
        description: "Develop and finalize detailed architectural and structural plans for the project.",
        subSteps: [
            { title: "Final architectural drawing", description: "Complete the final architectural plans ready for construction.", status: "" },
            { title: "Structural & MEP (Mechanical, Electrical & Plumbing)", description: "Detail out all structural, mechanical, electrical, and plumbing plans.", status: "" },
            { title: "3D visualization", description: "Create 3D visualizations to help the client visualize the final project.", status: "" },
        ],
        status: "",
    },
    {
        title: "Construction KickOff",
        description: "Begin the construction phase with all preparations and initial groundwork complete.",
        subSteps: [
            { title: "Detailed work schedule shared with client", description: "Share a detailed construction schedule with the client.", status: "" },
            { title: "Material procurement begins", description: "Start the procurement of necessary materials as per the project schedule.", status: "" },
            { title: "Site safety check completed", description: "Ensure all safety measures are in place and verified before construction begins.", status: "" },
        ],
        status: "",
    },
    {
        title: "Foundation & structure",
        description: "Begin the construction phase with all preparations and initial groundwork complete.",
        subSteps: [
            { title: "Detailed work schedule shared with client", description: "Share a detailed construction schedule with the client.", status: "" },
            { title: "Material procurement begins", description: "Start the procurement of necessary materials as per the project schedule.", status: "" },
            { title: "Site safety check completed", description: "Ensure all safety measures are in place and verified before construction begins.", status: "" },
        ],
        status: "",
    },
    {
        title: "Brickwork & masonry",
        description: "Begin the construction phase with all preparations and initial groundwork complete.",
        subSteps: [
            { title: "Detailed work schedule shared with client", description: "Share a detailed construction schedule with the client.", status: "" },
            { title: "Material procurement begins", description: "Start the procurement of necessary materials as per the project schedule.", status: "" },
            { title: "Site safety check completed", description: "Ensure all safety measures are in place and verified before construction begins.", status: "" },
        ],
        status: "",
    },
    {
        title: "Internal finishing",
        description: "Begin the construction phase with all preparations and initial groundwork complete.",
        subSteps: [
            { title: "Detailed work schedule shared with client", description: "Share a detailed construction schedule with the client.", status: "" },
            { title: "Material procurement begins", description: "Start the procurement of necessary materials as per the project schedule.", status: "" },
            { title: "Site safety check completed", description: "Ensure all safety measures are in place and verified before construction begins.", status: "" },
        ],
        status: "",
    },
    {
        title: "Final touches & handover",
        description: "Begin the construction phase with all preparations and initial groundwork complete.",
        subSteps: [
            { title: "Detailed work schedule shared with client", description: "Share a detailed construction schedule with the client.", status: "" },
            { title: "Material procurement begins", description: "Start the procurement of necessary materials as per the project schedule.", status: "" },
            { title: "Site safety check completed", description: "Ensure all safety measures are in place and verified before construction begins.", status: "" },
        ],
        status: "",
    },
];

import crypto from "crypto";

const generateToken = () => crypto.randomBytes(24).toString("hex");

export const wizardCreateProject = async (req, res) => {
    try {
        const { projectId, projectTitle = "", city = "", state = "" } = req.body;

        if (!projectId) {
            return res.status(400).json({ success: false, message: "projectId is required" });
        }

        const exists = await Project.findOne({ projectId });
        if (exists) {
            return res.status(409).json({ success: false, message: "projectId already exists" });
        }

        const doc = await Project.create({
            projectId,
            projectTitle,
            city,
            state,
            isDraft: true,
            wizard: { currentStep: 1, completed: false },
            boardAccess: {
                enabled: false,
                visibility: "qr_only",
                showOwnerPublicly: true,
            },
            boardProfile: {
                contractorName: "Towardsnorth Global Projects Pvt. Ltd.",
            },
        });

        return res.json({ success: true, project: doc });
    } catch (e) {
        return res.status(500).json({ success: false, message: e.message });
    }
};

export const wizardUpdateBasic = async (req, res) => {
    try {
        const { projectId } = req.params;

        // Never allow patch to include the whole wizard object (avoids conflicts)
        const patch = { ...(req.body || {}) };
        delete patch.wizard;

        const update = {
            $set: {
                ...patch,
                "wizard.currentStep": 2, // or Math.max(existing,2) if you prefer
            },
        };

        const doc = await Project.findOneAndUpdate({ projectId }, update, { new: true });

        if (!doc) return res.status(404).json({ success: false, message: "Project not found" });
        return res.json({ success: true, project: doc });
    } catch (e) {
        return res.status(500).json({ success: false, message: e.message });
    }
};

export const wizardUpdateStakeholders = async (req, res) => {
    try {
        const { projectId } = req.params;
        const stakeholders = req.body || {};

        const doc = await Project.findOneAndUpdate(
            { projectId },
            { $set: { stakeholders, "wizard.currentStep": 3 } },
            { new: true }
        );

        if (!doc) return res.status(404).json({ success: false, message: "Project not found" });
        return res.json({ success: true, project: doc });
    } catch (e) {
        return res.status(500).json({ success: false, message: e.message });
    }
};

export const wizardUpdateQuotation = async (req, res) => {
    try {
        const { projectId } = req.params;
        const { details = null, summary = null, quotationType = "" } = req.body || {};

        const doc = await Project.findOneAndUpdate(
            { projectId },
            {
                $set: {
                    "quotation.details": details,
                    "quotation.summary": summary || undefined,
                    "quotation.quotationType": quotationType,
                    "quotation.lastUpdatedAt": new Date(),
                    "wizard.currentStep": 4,
                },
            },
            { new: true }
        );

        if (!doc) return res.status(404).json({ success: false, message: "Project not found" });
        return res.json({ success: true, project: doc });
    } catch (e) {
        return res.status(500).json({ success: false, message: e.message });
    }
};

export const wizardUpdateBoard = async (req, res) => {
    try {
        const { projectId } = req.params;
        const { enabled, visibility, showOwnerPublicly, boardProfile } = req.body || {};

        const project = await Project.findOne({ projectId });
        if (!project) return res.status(404).json({ success: false, message: "Project not found" });

        // generate tokens only once
        if (enabled && !project.boardAccess?.specToken) {
            project.boardAccess.specToken = generateToken();
        }
        if (enabled && !project.boardAccess?.updatesToken) {
            project.boardAccess.updatesToken = generateToken();
        }

        project.boardAccess.enabled = !!enabled;
        if (visibility) project.boardAccess.visibility = visibility;
        if (typeof showOwnerPublicly === "boolean") project.boardAccess.showOwnerPublicly = showOwnerPublicly;

        if (boardProfile && typeof boardProfile === "object") {
            project.boardProfile = { ...(project.boardProfile || {}), ...boardProfile };
        }

        project.wizard.currentStep = 5;
        await project.save();

        return res.json({ success: true, project });
    } catch (e) {
        return res.status(500).json({ success: false, message: e.message });
    }
};

const toProgressPercent = (v) => {
    if (v == null) return 0;
    const s = String(v).trim();
    const m = s.match(/(\d+(\.\d+)?)/);
    const n = m ? Number(m[1]) : 0;
    return Number.isFinite(n) ? Math.max(0, Math.min(100, n)) : 0;
};

const safeDate = (d) => (d ? new Date(d) : null);

const buildStepsSummary = (steps = []) => {
    const arr = Array.isArray(steps) ? steps : [];
    const total = arr.length;
    const completed = arr.filter((s) => String(s?.status) === "completed").length;
    const ongoing = arr.find((s) => String(s?.status) === "ongoing-stage") || null;

    // Return trimmed view for public
    const normalized = arr.slice(0, 200).map((s) => ({
        title: s?.title || "",
        description: s?.description || "",
        status: s?.status || "",
        subSteps: Array.isArray(s?.subSteps)
            ? s.subSteps.slice(0, 50).map((ss) => ({
                title: ss?.title || "",
                description: ss?.description || "",
                status: ss?.status || "",
            }))
            : [],
    }));

    return {
        total,
        completed,
        ongoingTitle: ongoing?.title || "",
        ongoingDescription: ongoing?.description || "",
        steps: normalized,
    };
};

const buildPaymentSummary = (paymentSchedule = [], contractValue = 0) => {
    const arr = Array.isArray(paymentSchedule) ? paymentSchedule : [];

    const total = arr.length;
    const paidCount = arr.filter((p) => p?.status === "paid").length;
    const dueCount = arr.filter((p) => p?.status === "due").length;
    const overdueCount = arr.filter((p) => p?.status === "overdue").length;

    const paidAmount = arr.reduce((sum, p) => sum + (Number(p?.paidAmount) || 0), 0);
    const scheduledAmount = arr.reduce((sum, p) => sum + (Number(p?.amount) || 0), 0);

    const nextDue = arr
        .filter((p) => p?.status !== "paid" && !p?.reminderDisabled)
        .sort((a, b) => new Date(a?.dueDate || 0) - new Date(b?.dueDate || 0))[0];

    return {
        total,
        paidCount,
        dueCount,
        overdueCount,
        totals: {
            contractValue: Number(contractValue) || 0,
            scheduledAmount,
            paidAmount,
        },
        nextDue: nextDue
            ? {
                key: nextDue.key || "",
                label: nextDue.label || "",
                percentage: Number(nextDue.percentage) || 0,
                amount: Number(nextDue.amount) || 0,
                dueDate: nextDue.dueDate ? new Date(nextDue.dueDate) : null,
                status: nextDue.status || "pending",
                notes: nextDue.notes || "",
            }
            : null,
    };
};

export const publicGetSpecsByToken = async (req, res) => {
    try {
        const { token } = req.params;

        const project = await Project.findOne({
            "boardAccess.specToken": token,
            "boardAccess.enabled": true,
        }).lean();

        console.log('project:', project);

        if (!project) {
            return res.status(404).json({ success: false, message: "Invalid board" });
        }

        return res.json({
            success: true,
            data: {
                brand: {
                    name: project.boardProfile?.contractorName || "TowardsNorth",
                    logoSrc: "/assets/tn/logo.png",
                },

                project: {
                    projectId: project.projectId,
                    projectDisplayName:
                        project.boardProfile?.projectDisplayName ||
                        project.projectTitle ||
                        "Construction Project",
                    city: project.city || "",
                    lastUpdated: project.specBoard?.lastUpdatedAt || project.updatedAt,
                },

                keySpecs: project.specBoard?.keySpecs || [],
                materials: project.specBoard?.materials || [],
                executionFlow: project.specBoard?.executionFlow || [],
                transparency: project.specBoard?.transparency || [],
            },
        });
    } catch (e) {
        return res.status(500).json({ success: false, message: e.message });
    }
};

export const publicGetUpdatesByToken = async (req, res) => {
    try {
        const { token } = req.params;

        const project = await Project.findOne({
            "boardAccess.updatesToken": token,
            "boardAccess.enabled": true,
        }).lean();

        if (!project) {
            return res.status(404).json({ success: false, message: "Invalid updates board" });
        }

        return res.json({
            success: true,
            data: {
                brand: {
                    name: project.boardProfile?.contractorName || "TowardsNorth",
                },

                project: {
                    projectDisplayName:
                        project.boardProfile?.projectDisplayName ||
                        project.projectTitle ||
                        "Construction Project",
                },

                stages: project.updatesBoard?.stages || [],
                lastUpdated: project.updatesBoard?.lastUpdatedAt || project.updatedAt,
            },
        });
    } catch (e) {
        return res.status(500).json({ success: false, message: e.message });
    }
}

export const adminAddProjectUpdate = async (req, res) => {
    try {
        const { projectId } = req.params;
        const { title, description, progressPercent, photos = [], tags = [], date } = req.body || {};

        if (!title || !String(title).trim()) {
            return res.status(400).json({ success: false, message: "title is required" });
        }

        const project = await Project.findOne({ projectId });
        if (!project) return res.status(404).json({ success: false, message: "Project not found" });

        const update = {
            title: String(title).trim(),
            description: String(description || "").trim(),
            progressPercent: Math.max(0, Math.min(100, Number(progressPercent) || 0)),
            photos: Array.isArray(photos) ? photos.filter(Boolean).slice(0, 30) : [],
            tags: Array.isArray(tags) ? tags.filter(Boolean).slice(0, 20) : [],
            date: date ? new Date(date) : new Date(),
        };

        project.updates = project.updates || [];
        project.updates.push(update);

        await project.save();

        const saved = project.updates[project.updates.length - 1];

        return res.json({
            success: true,
            data: {
                projectId: project.projectId,
                updatedAt: project.updatedAt,
                update: {
                    _id: saved?._id,
                    date: saved?.date,
                    title: saved?.title,
                    description: saved?.description,
                    progressPercent: saved?.progressPercent,
                    photos: saved?.photos || [],
                    tags: saved?.tags || [],
                },
            },
        });
    } catch (e) {
        return res.status(500).json({ success: false, message: e.message });
    }
};

export const wizardUpdateSpecsBoard = async (req, res) => {
    try {
        const { projectId } = req.params;
        const specBoard = req.body || {};

        const doc = await Project.findOneAndUpdate(
            { projectId },
            {
                $set: {
                    specBoard: {
                        ...specBoard,
                        lastUpdatedAt: new Date(),
                    },
                    "wizard.currentStep": 4,
                },
            },
            { new: true }
        );

        if (!doc) {
            return res.status(404).json({ success: false, message: "Project not found" });
        }

        return res.json({ success: true, project: doc });
    } catch (e) {
        return res.status(500).json({ success: false, message: e.message });
    }
};

export const wizardUpdateUpdatesBoard = async (req, res) => {
    try {
        const { projectId } = req.params;
        const { stages = [] } = req.body || {};

        const doc = await Project.findOneAndUpdate(
            { projectId },
            {
                $set: {
                    updatesBoard: {
                        stages,
                        lastUpdatedAt: new Date(),
                    },
                },
            },
            { new: true }
        );

        if (!doc) {
            return res.status(404).json({ success: false, message: "Project not found" });
        }

        return res.json({ success: true, project: doc });
    } catch (e) {
        return res.status(500).json({ success: false, message: e.message });
    }
};

// Controller to create a new project
export const createProject = async (req, res) => {
    const session = await mongoose.startSession();
    try {
        session.startTransaction();

        const { clientName, clientEmail, clientMobile, clientCity, projectType, plotInformation, newlyAdded } = req.body;

        // Validation: Check if any of the required fields are empty
        if (!clientName || !clientEmail || !clientMobile || !clientCity || !projectType) {
            return res.status(400).json({ message: 'All fields must be filled.', success: false });
        }

        // Additional validation to check if plot information fields are filled
        const { areaOfPlot, length, breadth, plotLocation } = plotInformation;
        if (!areaOfPlot || !length || !breadth || !plotLocation) {
            return res.status(400).json({ message: 'All plot information fields must be filled.', success: false });
        }

        const userId = generateProjectId(); // Ensure this ID is unique and correctly generated

        // Create or update user details
        const user = await User.findOneAndUpdate({ userId: userId }, {
            username: clientName,
            email: clientEmail,
            mobile: clientMobile,
            projectType: projectType,
            plotInformation: plotInformation,
            steps: predefinedSteps,
        }, { new: true, upsert: true, session }); // upsert will create a new doc if none match

        if (!user) {
            return res.status(400).json({ message: 'already exist', success: false });
        }

        const newProject = new Project({
            projectId: userId,
            clientName,
            clientEmail,
            clientMobile,
            clientCity,
            projectType,
            plotInformation,
            newlyAdded,
            steps: predefinedSteps,
        });

        const saveProjectsDetails = await newProject.save({ session });

        await session.commitTransaction();
        res.status(201).json({ message: "Project Created Successfully", success: true, data: saveProjectsDetails });
    } catch (error) {
        console.error('Transaction error:', error); // Enhanced logging
        await session.abortTransaction();
        res.status(500).json({ message: 'Server error', error: error.message, success: false });
    } finally {
        session.endSession();
    }
};

export const getProjects = async (req, res) => {
    try {
        const projects = await Project.find();
        res.status(200).json(projects);
    } catch (error) {
        res.status(500).json({ message: 'Error fetching projects', error: error.message });
    }
};

export const getProjectsById = async (req, res) => {
    try {
        const { id } = req.params;
        const projects = await Project.findById(id);
        res.status(200).json(projects);
    } catch (error) {
        res.status(500).json({ message: 'Error fetching projects', error: error.message });
    }
};

// ðŸ”¹ GET /api/projects/my/payments
// Returns the latest project for the logged-in client with paymentSchedule
export const getMyPaymentSchedule = async (req, res) => {
    try {
        const userId = req.user?._id;
        if (!userId) {
            return res
                .status(401)
                .json({ success: false, message: "Unauthorized" });
        }

        // Find the latest project created from this client (approved estimate flow)
        const project = await Project.findOne({ clientId: userId })
            .sort({ createdAt: -1 })
            .select(
                "projectId projectTitle siteAddress city state contractValue status paymentSchedule"
            )
            .lean();

        if (!project) {
            return res.status(404).json({
                success: false,
                message: "No project found for this user",
            });
        }

        return res.status(200).json({
            success: true,
            data: project,
        });
    } catch (error) {
        console.error("getMyPaymentSchedule error:", error);
        return res.status(500).json({
            success: false,
            message: "Server error while loading payment schedule",
        });
    }
};

export const getProjectsByAssignedMember = async (req, res) => {
    try {
        const { id } = req.params;

        // Ensure the ID is a valid MongoDB ObjectId
        if (!mongoose.isValidObjectId(id)) {
            return res.status(400).json({ message: "Invalid team member ID" });
        }

        // Fetch projects where the assignedTeamMembers array contains the given team member ID
        // Adjust the query to match the `id` field within the `assignedTeamMembers` array of objects
        const projects = await Project.find({
            'assignedTeamMember.id': id
        });

        if (projects.length === 0) {
            return res.status(404).json({ message: "No projects found for this team member." });
        }

        res.status(200).json(projects);
    } catch (error) {
        res.status(500).json({ message: 'Error fetching projects', error: error.message });
    }
};

export const approveProjects = async (req, res) => {
    try {
        const { id } = req.params;
        // Fetch the project including the user information to validate existence
        const project = await Project.findById(id).populate('projectId');  // Assuming 'projectId' is populated to fetch user details
        if (!project) {
            return res.status(404).json({ message: 'Project not found', success: false, });
        }
        if (!project.projectId) {
            return res.status(404).json({ message: 'No user associated with this project', success: false, });
        }

        // Check if the user still exists in the database
        const user = await User.findOne({ userId: project.projectId });
        if (!user) {
            return res.status(404).json({ message: 'User not found' });
        }

        // Update the user's approval status
        user.isApproved = true;
        await user.save();

        // Update the project's status
        project.status = 'Approved';
        project.newlyAdded = 'false';
        project.yetToClose = 'true';
        await project.save();

        res.json({ message: 'Project approved successfully', project, user, success: true, });
    } catch (error) {
        console.error('Error approving the project:', error);
        res.status(500).json({ message: 'Error approving the project', error: error.message, success: false, });
    }
};

export const quotationDetailsUpdate = async (req, res) => {
    try {
        const { id } = req.params;

        const project = await Project.findById(id);
        if (!project) {
            return res.status(404).json({ message: 'Project not found', success: false, });
        }

        // Check if the user still exists in the database
        // const user = await User.findOne({ userId: project.projectId });
        // if (!user) {
        //     return res.status(404).json({ message: 'User not found' });
        // }

        // Function to update the sub-step status
        const updateSubStepStatus = (steps, stepTitle, subStepTitle, newStatus) => {
            const step = steps.find(step => step.title === stepTitle);
            if (step) {
                const subStep = step.subSteps.find(subStep => subStep.title === subStepTitle);
                if (subStep) {
                    subStep.status = newStatus;
                }
            }
        };
        // Update sub-step in Project
        updateSubStepStatus(project.steps, "Package Discovery", "Submitted Quotation", "ongoing-stage");
        // Update sub-step in User, assuming User has a similar steps structure
        // updateSubStepStatus(user.steps, "Package Discovery", "Submitted Quotation", "ongoing-stage");

        // user.constructionDetails.push(req.body);
        // user.save();

        project.constructionDetails.push(req.body);
        project.save();

        // await logActivity(project, {
        //     type: 'quotation.shared',
        //     name: 'Quotation Shared',
        //     description: req.body?.title || req.body?.packageName || 'Submitted Quotation',
        //     actor: { name: 'Sales', role: 'Sales', actorType: 'employee' },
        //     meta: { construction: req.body },
        // });

        res.json({ message: 'construction details updated successfully', project, success: true, });

    } catch (error) {
        console.error('Error updating construction details:', error);
        res.status(500).json({ message: 'Error updating construction details', error: error.message, success: false, });
    }
}

export const handleApprovedRequestedQuotation = async (req, res) => { // add
    try {

        const { userId, constructionId } = req.params;

        // Update constructionDetails in User schema
        const updatedUser = await User.findOneAndUpdate(
            { userId: userId, "constructionDetails.totalPackageCost": constructionId }, // Find user and correct array item
            {
                $set: {
                    "constructionDetails.$.status": "Approved", // Update requested
                    "constructionDetails.$.requested": false, // Update requested
                    "constructionDetails.$.approved": true, // Update approved
                }
            },
            { new: true } // Return updated document
        );

        if (!updatedUser) {
            return res.status(404).json({ message: "User not found" });
        }

        // Update projectDetails in Project schema
        const updatedProjects = await Project.findOneAndUpdate(
            { projectId: userId, "constructionDetails.totalPackageCost": constructionId }, // Find user and correct array item
            {
                $set: {
                    "constructionDetails.$.status": "Approved", // Update requested
                    "constructionDetails.$.requested": false, // Update requested
                    "constructionDetails.$.approved": true, // Update approved
                }
            },
            { new: true } // Return updated document
        );

        const proj = await Project.findOne({ projectId: userId });
        await logActivity(proj, {
            type: 'quotation.approved',
            name: 'Quotation Approved',
            description: `Package approved (ID: ${constructionId})`,
            actor: { name: 'System', actorType: 'system' },
            meta: { constructionId },
        });

        const emailHtml = `
            <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        body {
                            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
                            margin: 0;
                            padding: 0;
                            color: #333;
                            background-color: #f4f4f7;
                        }
                        .email-container {
                            max-width: 600px;
                            margin: 20px auto;
                            background: white;
                            border: 1px solid #ddd;
                            overflow: hidden;
                        }
                        .header {
                            background-color: #0056b3;
                            color: white;
                            padding: 10px 20px;
                            text-align: center;
                            font-size: 24px;
                        }
                        .content {
                            padding: 20px;
                            line-height: 1.6;
                        }
                        .footer {
                            background-color: #f9f9f9;
                            text-align: center;
                            padding: 10px 20px;
                            font-size: 12px;
                            color: #666;
                        }
                        .button {
                            padding: 10px 15px;
                            color: white;
                            background-color: #28a745;
                            border-radius: 5px;
                            text-decoration: none;
                            font-weight: bold;
                        }
                    </style>
                </head>
                <body>
                    <div class="email-container">
                        <div class="header">
                            Quotation Approval Notification
                        </div>
                        <div class="content">
                            <p>Hello [Client Name],</p>
                            <p>We are pleased to inform you that your quotation for the <strong>[Project Name]</strong> has been officially approved. Below are the details of the approved quotation for your construction project:</p>
                            <ul>
                                <li>Project Name: [Project Name]</li>
                                <li>Quotation Number: [Quotation Number]</li>
                                <li>Total Cost: [Total Cost]</li>
                                <li>Estimated Start Date: [Estimated Start Date]</li>
                                <li>Estimated Completion Date: [Estimated Completion Date]</li>
                            </ul>
                            <p>This approval marks the beginning of the construction phase, and we are excited to proceed. Please review the attached project schedule and documentation for more detailed information.</p>
                            <p>To view your project details or manage your account, please click the button below:</p>
                            <a href="[Project URL]" class="button">View Project</a>
                            <p>Thank you for your cooperation and trust in us. We look forward to building a successful partnership.</p>
                        </div>
                        <div class="footer">
                            <p>If you have any questions or need further assistance, please contact us at [Contact Email] or [Contact Phone].</p>
                            <p>Â© [Year] [Your Company Name]. All rights reserved.</p>
                        </div>
                    </div>
                </body>
            </html>
        `;

        await sendmail(updatedUser.email, "Your OTP for 99Squarewall Login", emailHtml);

        res.status(200).json({
            message: "Status updated successfully",
            user: updatedUser,
            updatedProjects,
            success: true,
        });

    } catch (error) {
        console.error('Error:', error);
        res.status(500).json({ message: 'Error updating construction details', error: error.message, success: false, });
    }
}

// Update Site Visit Readiness and Progress
export const updateSiteVisitReadiness = async (req, res) => {
    try {
        const { id } = req.params;
        const { assignedExpert, isReady } = req.body;

        const project = await Project.findById(id);

        if (!project) {
            return res.status(404).json({ success: false, message: "Project not found" });
        }

        // Update Site Visit Readiness
        project.siteVisitReportDetails = {
            assignedExpert,
            isReady,
            createdAt: new Date(),
        };

        // Update Task Progress
        const taskProgress = project.taskProgress.find(stage => stage.stageName === "Site Visit");
        if (taskProgress) {
            const task = taskProgress.tasks.find(t => t.taskName === "Ensure Ready for Visit");
            if (task) {
                task.status = "completed";
            }

            // Move to the next step: "Proceed Visit Site"
            const nextTask = taskProgress.tasks.find(t => t.taskName === "Proceed Visit Site");
            if (nextTask) {
                nextTask.status = "Ongoing";
            }
        }

        await project.save();

        // ðŸ”” Activity
        await logActivity(project, {
            type: 'site_visit.scheduled',
            name: 'Site Visit Scheduled',
            description: `Assigned: ${assignedExpert || 'TBD'} â€¢ Ready: ${isReady ? 'Yes' : 'No'}`,
            actor: { name: assignedExpert || 'System', role: 'Site Engineer', actorType: 'employee' },
            meta: { when: project.siteVisitReportDetails?.createdAt },
        });

        res.status(200).json({
            success: true,
            message: "Site visit readiness updated successfully.",
            project
        });

    } catch (error) {
        console.error("Error updating site visit readiness:", error);
        res.status(500).json({ success: false, message: "Internal server error" });
    }
};

export const proceedVisit = async (req, res) => {
    try {
        const { id, taskId } = req.params;
        const {
            clientAttendance,
            sitePhotos,
            terrainCondition,
            excavationStatus,
            waterElectricity,
            neighboringConditions,
            surroundingObstacles,
            accessToSite,
            clientInterestLevel,
            gpsLocation,
            additionalNotes,
            visitCompleted
        } = req.body;

        // âœ… Validate required fields
        if (
            clientAttendance === undefined ||
            !sitePhotos ||
            !terrainCondition ||
            !gpsLocation ||
            gpsLocation.latitude === undefined ||
            gpsLocation.longitude === undefined
        ) {
            return res.status(400).json({ success: false, error: "Missing required fields" });
        }

        const project = await Project.findById(id);

        if (!project) {
            return res.status(404).json({ success: false, message: "Project not found" });
        }

        // Update Task Progress
        const taskProgress = project.taskProgress.find(stage => stage.stageName === "Site Visit");
        if (taskProgress) {
            taskProgress.progress = "Completed";
            const task = taskProgress.tasks.find(t => t.taskName === "Ensure Ready for Visit");
            if (task) {
                task.status = "completed";
            }

            // Move to the next step: "Proceed Visit Site"
            const nextTask = taskProgress.tasks.find(t => t.taskName === "Proceed Visit Site");
            if (nextTask) {
                nextTask.status = "completed";
            }
        }

        project.status = "Site Visit Done";

        // Update Site Visit Readiness
        project.siteVisitReportDetails = {
            ...project.siteVisitReportDetails,
            step: "Proceed Visit Site", // Ensure 'step' is set
            clientAttendance,
            sitePhotos,
            terrainCondition,
            excavationStatus,
            waterElectricity,
            neighboringConditions,
            surroundingObstacles,
            accessToSite,
            clientInterestLevel,
            gpsLocation,
            additionalNotes,
            visitCompleted,
            status: "pending",
        };

        // âœ… Update Assigned Task using `taskId`
        const assignedTask = project.assignedTasks.find(task => task._id.toString() === taskId);
        if (assignedTask) {
            assignedTask.status = "Completed";
        }

        await project.save();

        // ðŸ”” Activity
        await logActivity(project, {
            type: 'site_visit.completed',
            name: 'Site Visit Completed',
            description: project.siteVisitReportDetails?.meetingDetails || 'Visit report submitted',
            actor: { name: project.siteVisitReportDetails?.assignedExpert || 'System', role: 'Site Engineer', actorType: 'employee' },
        });

        // âœ… Send success response
        res.status(201).json({
            message: "Site visit data saved successfully",
            success: true,
            data: project
        });

    } catch (error) {
        console.error("Error saving site visit:", error);
        res.status(500).json({ success: false, error: "Failed to save site visit data" });
    }
};

export const approveSiteVisitByHigherAuthority = async (req, res) => {
    try {
        const { id } = req.params;

        // Find the project by ID
        const project = await Project.findById(id);

        if (!project) {
            return res.status(404).json({ success: false, message: "Project not found" });
        }

        // Update the status field inside siteVisitReportDetails
        project.siteVisitReportDetails.status = "Approved Site Visit";

        // Save the updated project
        await project.save();

        // ðŸ”” Activity
        await logActivity(project, {
            type: 'site_visit.approved',
            name: 'Site Visit Approved',
            description: 'Higher authority approved the site visit.',
            actor: { name: 'System', actorType: 'system' },
        });

        // Send a success response
        res.status(200).json({
            success: true,
            message: "Site visit approved successfully."
        });

    } catch (error) {
        // Log and respond with error information
        console.error("Error updating site visit status:", error);
        res.status(500).json({ success: false, message: "Internal server error" });
    }
}

export const updateIsSiteVisit = async (req, res) => {
    try {
        const { id } = req.params; // Assuming projectId is used to identify the project
        const { isSiteVisit } = req.body; // Boolean value to update

        const updatedProject = await Project.findByIdAndUpdate(
            { _id: id },
            {
                isSiteVisit,
                "siteVisitReportDetails.status": "In Progress"  // Update the status
            },
            { new: true }
        );

        if (!updatedProject) {
            return res.status(404).json({ success: false, message: "Project not found" });
        }

        try {
            const proj = await Project.findById(id);
            await logActivity(proj, {
                type: 'site_visit.flagged',
                name: 'Site Visit Initiated',
                description: `isSiteVisit set to ${String(isSiteVisit)}`,
                actor: { name: 'System', actorType: 'system' },
            });
        } catch { }

        res.status(200).json({ success: true, message: "Site visit status updated", updatedProject });

    } catch (error) {
        res.status(500).json({ success: false, message: "Error updating site visit status", error: error.message });
    }
};

// ðŸ› ï¸ Controller to update Design & Consultation Report
export const updateDesignConsultation = async (req, res) => {
    try {
        const { id } = req.params;  // Extract project ID from URL params
        const { callConnected, meetingType, meetingDate, meetingTime } = req.body;  // Extract data from request body

        // âœ… Validate required fields
        if (callConnected === undefined || !["At Home", "At Office"].includes(meetingType) || !meetingDate || !meetingTime) {
            return res.status(400).json({ success: false, message: "Missing or invalid required fields" });
        }

        // ðŸ› ï¸ Find project by ID
        const project = await Project.findById(id);

        if (!project) {
            return res.status(404).json({ success: false, message: "Project not found" });
        }

        // ðŸ› ï¸ Update Design & Consultation Report
        project.designConsultationReport = {
            callConnected,
            meetingType,
            meetingDate,
            meetingTime
        };

        // ðŸ› ï¸ Update main project status
        project.isDesignConsultation = true;  // Set to true as the step is now completed
        project.status = "Design & Consultation";

        // ðŸ› ï¸ Save updated project
        await project.save();

        await logActivity(project, {
            type: 'design.consultation',
            name: 'Design Consultation',
            description: `Type: ${meetingType} â€¢ ${meetingDate} ${meetingTime} â€¢ Call connected: ${callConnected ? 'Yes' : 'No'}`,
            actor: { name: 'System', actorType: 'system' },
            meta: { when: meetingDate, time: meetingTime },
        });

        res.status(200).json({
            success: true,
            message: "Design & Consultation Report updated successfully",
            data: project
        });

    } catch (error) {
        console.error("Error updating Design & Consultation Report:", error);
        res.status(500).json({ success: false, message: "Failed to update Design & Consultation Report", error: error.message });
    }
};

export const updateDesignConsultationStatus = async (req, res) => {
    try {
        const { id } = req.params; // Project ID

        // âœ… 1. Update Project Status
        const updatedProject = await Project.findByIdAndUpdate(
            { _id: id },
            {
                status: 'Proposal',
                isApproved: true,
            },
            { new: true }
        ).populate('assignedTeamMember.id');  // Populate team member details

        if (!updatedProject) {
            return res.status(404).json({ success: false, message: "Project not found" });
        }

        // âœ… 2. Extract RM Details
        const rmDetails = updatedProject.assignedTeamMember.find(member =>
            member.department.includes("Customer Support")
        );

        if (!rmDetails) {
            return res.status(404).json({ success: false, message: "RM not found" });
        }

        await logActivity(updatedProject, {
            type: 'stage.changed',
            name: 'Stage Updated',
            description: 'Status changed to Proposal',
            actor: { name: 'System', actorType: 'system' },
            meta: { changedTo: 'Proposal' },
        });

        const rmUser = await VendorUsers.findById(rmDetails.id);
        if (!rmUser) {
            return res.status(404).json({ success: false, message: "RM user not found" });
        }

        // âœ… 3. Create Client Login
        const user = await User.create({
            userId: updatedProject.projectId,
            username: updatedProject.clientName,
            email: updatedProject.clientEmail,
            mobile: updatedProject.clientMobile,
            img: "image",
            alternateNumber: "not-set",
            projectType: updatedProject.projectType,
            plotInformation: updatedProject.plotInformation,
            currentPhase: updatedProject.currentPhase,
            progress: '30%',
            steps: predefinedSteps,
            isApproved: true,
        });

        await user.save();

        // âœ… 4. Send Email to Client
        const clientEmailSubject = "ðŸŽ‰ Your Design Consultation Stage is Complete!";
        const clientEmailMessage = `
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px; background-color: #f9f9f9;">
                <div style="text-align: center;">
                    <img src="https://99squarewall.com/img/Logo-01.png" alt="99SquareWall" style="max-width: 150px; margin-bottom: 10px;">
                    <h2 style="color: #002FCA;">ðŸŽ‰ Design Consultation Stage Completed!</h2>
                </div>

                <div style="padding: 15px; background: #fff; border-radius: 8px; margin-bottom: 15px;">
                    <h3 style="color: #444;">Dear ${updatedProject.clientName},</h3>
                    <p>We are excited to inform you that the Design Consultation stage for your project <strong>${updatedProject.projectId}</strong> is now complete!</p>
                    <p>Our team has carefully reviewed your requirements and is preparing a personalized proposal for the next stage.</p>

                    <h3 style="color: #002FCA;">ðŸ“… What's Next?</h3>
                    <p>The next stage is <strong>Proposal</strong> where you will receive a detailed plan along with pricing options.</p>
                    <p>To stay updated, download our app and log in using your registered Mobile Number:</p>

                    <div style="text-align: center; margin: 20px 0;">
                        <a href="https://play.google.com/store/apps/details?id=com.nitinsuryawanshi.constructionapp&hl=en" target="_blank">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg" alt="Google Play Store" style="max-width: 150px; margin: 5px;">
                        </a>
                        <a href="https://apps.apple.com/in/app/99squarewall-home-construction/id6741794757" target="_blank">
                            <img src="https://developer.apple.com/assets/elements/badges/download-on-the-app-store.svg" alt="App Store" style="max-width: 150px; margin: 5px;">
                        </a>
                    </div>

                    <p>If you have any questions, feel free to contact us. Thank you for choosing 99SquareWall!</p>
                </div>

                <p style="font-size: 14px; color: #777; text-align: center; margin-top: 15px;">
                    For support, email us at 
                    <a href="mailto:support@99squarewall.com" style="color: #007bff;">support@99squarewall.com</a>
                </p>
            </div>
        `;
        await sendmail(updatedProject.clientEmail, clientEmailSubject, clientEmailMessage);

        // âœ… 5. Send Email to RM
        const rmEmailSubject = `ðŸ“‹ Design Consultation Completed for ${updatedProject.clientName}`;
        const rmEmailMessage = `
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px; background-color: #f9f9f9;">
                <div style="text-align: center;">
                    <img src="https://99squarewall.com/img/Logo-01.png" alt="99SquareWall" style="max-width: 150px; margin-bottom: 10px;">
                    <h2 style="color: #002FCA;">ðŸ“‹ Design Consultation Completed!</h2>
                </div>
                <div style="padding: 15px; background: #fff; border-radius: 8px; margin-bottom: 15px;">
                    <h3 style="color: #444;">Hello ${rmUser.username},</h3>
                    <p>The Design Consultation stage for project <strong>${updatedProject.projectId}</strong> is complete.</p>
                    <p><strong>Next Stage:</strong> Proposal</p>
                    <p>Please proceed with preparing the proposal.</p>
                    <h3>ðŸ“… Meeting Details</h3>
                    <p><strong>Client Name:</strong> ${updatedProject.clientName}</p>
                    <p><strong>Meeting Type:</strong> ${updatedProject.designConsultationReport?.meetingType || "Not specified"}</p>
                    <p><strong>Meeting Date:</strong> ${new Date(updatedProject.designConsultationReport?.meetingDate).toLocaleDateString() || "Not specified"}</p>
                    <p><strong>Meeting Time:</strong> ${new Date(updatedProject.designConsultationReport?.meetingDate).toLocaleTimeString() || "Not specified"}</p>
                    <p>Thank you!</p>
                </div>
            </div>
        `;
        await sendmail(rmUser.email, rmEmailSubject, rmEmailMessage);

        // âœ… 6. Send Response
        res.status(200).json({
            success: true,
            message: "Design Consultation status updated, user account created, and emails sent.",
            updatedProject,
            user,
        });

    } catch (error) {
        res.status(500).json({ success: false, message: "Error updating site visit status", error: error.message });
    }
}

// âœ… Controller to Save Proposal Approval Meeting Details
export const saveProposalApprovalMeeting = async (req, res) => {
    try {
        const { id } = req.params;  // Project ID
        const { callCompleted, meetingType, meetingDate, meetingTime } = req.body;

        // âœ… Find the project
        const project = await Project.findById(id);
        if (!project) {
            return res.status(404).json({ success: false, message: "Project not found" });
        }

        // âœ… Find the User associated with this project
        const user = await User.findOne({ userId: project.projectId });
        if (!user) {
            return res.status(404).json({ success: false, message: "User not found" });
        }

        // âœ… Find the assigned RM for Customer Support
        const assignedRM = project.assignedTeamMember.find(member => member.department.includes("Customer Support"));
        if (!assignedRM) {
            return res.status(400).json({ success: false, message: "No RM assigned for this project" });
        }

        // âœ… Ensure RM is assigned in User Schema
        const userAssignedRM = user.assignedTeamMember.find(member => member.department.includes("Customer Support"));
        if (!userAssignedRM) {
            return res.status(400).json({ success: false, message: "No RM assigned in User Schema" });
        }

        // âœ… Find the RM's full details
        const rm = await VendorUsers.findById({ _id: assignedRM.id });
        if (!rm) {
            return res.status(404).json({ success: false, message: "RM not found" });
        }

        // âœ… Update Construction Details Using MongoDB `$set`
        const updateFields = {
            "constructionDetails.$.stage": "Proposal Approval",
            "constructionDetails.$.status": callCompleted ? "Meeting Scheduled" : "Pending",
            "constructionDetails.$.callCompleted": callCompleted,
            "constructionDetails.$.meetingType": meetingType,
            "constructionDetails.$.meetingDate": meetingDate,
            "constructionDetails.$.meetingTime": meetingTime,
            "constructionDetails.$.assignedRM": rm._id
        };

        if (meetingType === "At Office") {
            updateFields["constructionDetails.$.officeLocation"] = "https://maps.app.goo.gl/zjsZhwaJ3Ru3HRkCA"; // Office location
        }

        // âœ… Update in Project Model
        await Project.updateOne(
            { _id: id, "constructionDetails.status": "RM Assigned" }, // Find only the correct element
            { $set: updateFields }
        );

        // âœ… Update in User Model
        await User.updateOne(
            { userId: project.projectId, "constructionDetails.status": "RM Assigned" },
            { $set: updateFields }
        );

        // âœ… Update Assigned Task Status to "Completed" for this RM
        // await Project.updateOne(
        //     { _id: id, "assignedTasks.assignedTo": rm.username }, // Find tasks assigned to this RM
        //     { $set: { "assignedTasks.$.status": "Completed" } }
        // );

        // âœ… Send Email to Client
        const clientEmailSubject = "ðŸ“¢ Your Proposal Approval Meeting is Scheduled!";
        const clientEmailMessage = `
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px; background-color: #f9f9f9;">
                <h2 style="color: #002FCA;">Your Proposal Approval Meeting Details</h2>
                <p>Dear <strong>${project.clientName}</strong>,</p>
                <p>Your proposal approval meeting has been scheduled.</p>
                <p><strong>Meeting Type:</strong> ${meetingType}</p>
                <p><strong>Meeting Date:</strong> ${new Date(meetingDate).toDateString()}</p>
                <p><strong>Meeting Time:</strong> ${meetingTime}</p>
                ${meetingType === "At Office" ? `<p><strong>Office Location:</strong> <a href="https://maps.app.goo.gl/zjsZhwaJ3Ru3HRkCA">View Location</a></p>` : ""}
                <p>For any questions, contact your Relationship Manager.</p>
            </div>
        `;
        await sendmail(project.clientEmail, clientEmailSubject, clientEmailMessage);

        // âœ… Send Email to RM
        const rmEmailSubject = "ðŸ“Œ New Proposal Approval Meeting Assigned!";
        const rmEmailMessage = `
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px; background-color: #f9f9f9;">
                <h2 style="color: #002FCA;">New Proposal Approval Task Assigned</h2>
                <p>Dear RM,</p>
                <p>You have been assigned a Proposal Approval meeting.</p>
                <p><strong>Client:</strong> ${project.clientName}</p>
                <p><strong>Meeting Type:</strong> ${meetingType}</p>
                <p><strong>Date:</strong> ${new Date(meetingDate).toDateString()}</p>
                <p><strong>Time:</strong> ${meetingTime}</p>
                ${meetingType === "At Office" ? `<p><strong>Office Location:</strong> <a href="https://maps.app.goo.gl/zjsZhwaJ3Ru3HRkCA">View Location</a></p>` : ""}
                <p>Please ensure you guide the client effectively.</p>
            </div>
        `;
        await sendmail(rm.email, rmEmailSubject, rmEmailMessage);

        res.status(200).json({ success: true, message: "Proposal approval meeting saved and notifications sent." });

    } catch (error) {
        console.error("Error in proposal approval:", error);
        res.status(500).json({ success: false, message: "Error saving proposal approval meeting.", error: error.message });
    }
};

export const handleStartMeeting = async (req, res) => {
    try {
        const { id } = req.params; // Assuming projectId is used to identify the project

        const project = await Project.findById(id);
        if (!project) {
            return res.status(404).json({ success: false, message: "Project not found" });
        }

        // âœ… Find the User associated with this project
        const user = await User.findOne({ userId: project.projectId });
        if (!user) {
            return res.status(404).json({ success: false, message: "User not found" });
        }

        const updateFields = {
            "constructionDetails.$.meetingStarted": true,
        };

        // âœ… Update in Project Model
        await Project.updateOne(
            { _id: id, "constructionDetails.status": "Meeting Scheduled" }, // Find only the correct element
            { $set: updateFields }
        );

        // âœ… Update in User Model
        await User.updateOne(
            { userId: project.projectId, "constructionDetails.status": "Meeting Scheduled" },
            { $set: updateFields }
        );

        await logActivity(project, {
            type: 'meeting.started',
            name: 'Proposal Meeting Started',
            description: 'Status set to â€œMeeting Scheduledâ€',
            actor: { name: 'System', actorType: 'system' },
        });

        res.status(200).json({ success: true, message: "Update Successfully." });

    } catch (error) {
        res.status(500).json({ success: false, message: "Error updating site visit status", error: error.message });
    }
}

export const saveMeetingOutcome = async (req, res) => {
    try {
        const { id } = req.params; // Project ID
        const { clientSatisfaction, modificationsNeeded, pricingConcerns, budgetFlexibility, clientRemarks, status } = req.body;

        // âœ… Determine Proposal Status
        let determinedStatus = "Proposal"; // Default to Proposal (Customization & Revisit)

        if (clientSatisfaction === "Very Happy" && !modificationsNeeded && !pricingConcerns && budgetFlexibility === "Flexible") {
            determinedStatus = "Won"; // Approved Proposal
        }
        else if ((clientSatisfaction === "Neutral" || clientSatisfaction === "Not Satisfied") && modificationsNeeded && !pricingConcerns) {
            determinedStatus = "Proposal"; // Customization
        }
        else if ((clientSatisfaction === "Neutral" || clientSatisfaction === "Not Satisfied") && pricingConcerns && budgetFlexibility === "Not Flexible") {
            determinedStatus = "Negotiation"; // Negotiation
        }
        else if (clientSatisfaction === "Not Satisfied" && modificationsNeeded && pricingConcerns) {
            determinedStatus = "Proposal"; // Revisit Proposal
        }

        // âœ… Find Project
        const project = await Project.findById(id);
        if (!project) {
            return res.status(404).json({ success: false, message: "Project not found" });
        }

        // âœ… Find the User associated with this project
        const user = await User.findOne({ userId: project.projectId });
        if (!user) {
            return res.status(404).json({ success: false, message: "User not found" });
        }

        console.log(user.steps);

        // âœ… Find the assigned RM for Customer Support
        const assignedRM = project.assignedTeamMember.find(member => member.department.includes("Customer Support"));
        if (!assignedRM) {
            return res.status(400).json({ success: false, message: "No RM assigned for this project" });
        }

        // âœ… Find RM Details
        const rm = await VendorUsers.findById(assignedRM.id);
        if (!rm) {
            return res.status(404).json({ success: false, message: "RM not found" });
        }

        // âœ… Update Construction Details Using `$set`
        const updateFields = {
            "constructionDetails.$.stage": "Proposal Meeting Outcome",
            "constructionDetails.$.status": status,
            "constructionDetails.$.clientSatisfaction": clientSatisfaction,
            "constructionDetails.$.modificationsNeeded": modificationsNeeded,
            "constructionDetails.$.pricingConcerns": pricingConcerns,
            "constructionDetails.$.budgetFlexibility": budgetFlexibility,
            "constructionDetails.$.clientRemarks": clientRemarks,
        };

        // âœ… Update in Project Model
        await Project.updateOne(
            { _id: id, "constructionDetails.status": "Meeting Scheduled" }, // Update only the correct entry
            {
                $set: updateFields,
                status: determinedStatus,
            }
        );

        // âœ… Update in User Model
        await User.updateOne(
            { userId: project.projectId, "constructionDetails.status": "Meeting Scheduled" },
            { $set: updateFields }
        );

        // âœ… Mark Assigned Task as Completed
        await Project.updateOne(
            { _id: id, "assignedTasks.assignedTo": rm.username },
            { $set: { "assignedTasks.$.status": "Completed" } }
        );

        // âœ… Send Email to Client
        const clientEmailSubject = "ðŸ“¢ Proposal Meeting Outcome Recorded!";
        const clientEmailMessage = `
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px; background-color: #f9f9f9;">
                <h2 style="color: #002FCA;">Your Proposal Meeting Outcome</h2>
                <p>Dear <strong>${project.clientName}</strong>,</p>
                <p>Thank you for attending the proposal meeting. Here is a summary of the discussion:</p>
                <ul>
                    <li><strong>Status:</strong> ${status}</li>
                    <li><strong>Client Satisfaction:</strong> ${clientSatisfaction}</li>
                    <li><strong>Modifications Needed:</strong> ${modificationsNeeded || "None"}</li>
                    <li><strong>Pricing Concerns:</strong> ${pricingConcerns ? "Yes" : "No"}</li>
                    <li><strong>Budget Flexibility:</strong> ${budgetFlexibility}</li>
                    <li><strong>Remarks:</strong> ${clientRemarks || "No additional remarks"}</li>
                </ul>
                <p>Our team will proceed with the next steps accordingly.</p>
            </div>
        `;
        await sendmail(project.clientEmail, clientEmailSubject, clientEmailMessage);

        // âœ… Send Email to RM
        const rmEmailSubject = "ðŸ“Œ Proposal Meeting Outcome Recorded!";
        const rmEmailMessage = `
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px; background-color: #f9f9f9;">
                <h2 style="color: #002FCA;">Proposal Meeting Outcome</h2>
                <p>Dear RM,</p>
                <p>The proposal meeting has been completed. Here are the recorded details:</p>
                <ul>
                    <li><strong>Client:</strong> ${project.clientName}</li>
                    <li><strong>Status:</strong> ${status}</li>
                    <li><strong>Client Satisfaction:</strong> ${clientSatisfaction}</li>
                    <li><strong>Modifications Needed:</strong> ${modificationsNeeded || "None"}</li>
                    <li><strong>Pricing Concerns:</strong> ${pricingConcerns ? "Yes" : "No"}</li>
                    <li><strong>Budget Flexibility:</strong> ${budgetFlexibility}</li>
                    <li><strong>Remarks:</strong> ${clientRemarks || "No additional remarks"}</li>
                </ul>
                <p>Proceed with the next steps accordingly.</p>
            </div>
        `;
        await sendmail(rm.email, rmEmailSubject, rmEmailMessage);

        // âœ… Find the "Package selection & customization" Step
        if (!user.steps) user.steps = []; // Ensure steps array exists

        const packageStepIndex = user.steps.findIndex(step => step.title === "Package selection & customization");
        const agreementStepIndex = user.steps.findIndex(step => step.title === "Agreement & booking payment");

        if (packageStepIndex !== -1) {
            let subSteps = [...(user.steps[packageStepIndex]?.subSteps || [])];

            console.log(subSteps);

            // âœ… Update Sub-Steps Based on Proposal Status
            if (status === "Approved Proposal") {
                subSteps = subSteps.map(sub => ({ ...sub, status: "completed" })); // All done
                user.steps[packageStepIndex].status = "completed";

                // ðŸ”“ **Unlock Agreement & Booking Payment Step**
                if (agreementStepIndex !== -1) {
                    user.steps[agreementStepIndex].status = "ongoing-stage";
                }
            } else if (status === "Customization") {
                subSteps[0].status = "completed"; // Standard Package
                subSteps[1].status = "completed"; // Add-ons
                user.steps[packageStepIndex].status = "ongoing-stage";

                // âŒ Keep Agreement & Booking Payment Step Locked
                if (agreementStepIndex !== -1) {
                    user.steps[agreementStepIndex].status = "";
                }
            } else if (status === "Negotiation") {
                subSteps[0].status = "completed"; // Standard Package
                user.steps[packageStepIndex].status = "ongoing-stage";

                // ðŸ”“ **Unlock Agreement & Booking Payment Step in Pending State**
                if (agreementStepIndex !== -1) {
                    user.steps[agreementStepIndex].status = "";
                }
            } else {
                subSteps = subSteps.map(sub => ({ ...sub, status: "" })); // Reset
                user.steps[packageStepIndex].status = "ongoing-stage";

                // âŒ Keep Agreement & Booking Payment Step Locked
                if (agreementStepIndex !== -1) {
                    user.steps[agreementStepIndex].status = "";
                }
            }

            // âœ… Apply Updates
            user.steps[packageStepIndex].subSteps = subSteps;
            await user.save();

            console.log(`âœ… Package selection step updated for Project: ${project._id}`);
        }

        await logActivity(project, {
            type: 'meeting.outcome',
            name: 'Proposal Meeting Outcome',
            description: `Outcome: ${determinedStatus}`,
            actor: { name: 'System', actorType: 'system' },
            meta: { determinedStatus },
        });

        res.status(200).json({ success: true, message: "Meeting outcome saved successfully and notifications sent." });

    } catch (error) {
        console.error("Error saving meeting outcome:", error);
        res.status(500).json({ success: false, message: "Failed to save meeting outcome", error: error.message });
    }
};

/**
 * Admin / RM clicks "Send Agreement"
 *
 * URL:   POST /api/projects/:projectId/send-agreement
 * Auth:  requireCRM (or RM with permission)
 */
export const sendAgreementEmail = async (req, res) => {
    try {
        const { projectId } = req.params;
        const actorId = req.user?._id; // CRM / RM user id

        // 1) Load project
        const project = await Project.findById(projectId);

        if (!project) {
            return res.status(404).json({ ok: false, message: "Project not found" });
        }

        // Guard: already signed
        if (project.agreement?.acceptedAt) {
            return res.status(400).json({
                ok: false,
                message: "Agreement already accepted. Project is already started or ready to start.",
            });
        }

        // Guard: project status should be agreement_pending or agreement_sent
        if (!["agreement_pending", "agreement_sent"].includes(project.status)) {
            return res.status(400).json({
                ok: false,
                message: `Cannot send agreement in current status: ${project.status}`,
            });
        }

        // 2) Load client details
        const client = await User.findById(project.clientId);

        if (!client || !client.email) {
            return res.status(400).json({
                ok: false,
                message: "Client email not found for this project.",
            });
        }

        const clientName =
            client.fullName ||
            client.name ||
            client.username ||
            client.firstName ||
            "Sir/Madam";

        // 3) Ensure agreement token exists
        if (!project.agreement) {
            project.agreement = {};
        }
        if (!project.agreement.token) {
            project.agreement.token = crypto.randomUUID();
        }

        // 4) Build signing URL
        const agreementAppUrl =
            process.env.AGREEMENT_APP_URL ||
            process.env.APP_PUBLIC_URL ||
            "https://app.99squarewall.com";

        const signingUrl = `${agreementAppUrl}?token=${project.agreement.token}&projectId=${project._id}`;

        console.log('client:', client);

        // 5) Pull structured info for the email
        const plot = project.plotInformation || {};
        const latestConstruction =
            Array.isArray(client.constructionDetails) &&
                client.constructionDetails.length
                ? client.constructionDetails[client.constructionDetails.length - 1]
                : null;

        const areaOfPlot = plot.areaOfPlot || "";
        const configurationName = latestConstruction?.configurationName || "";
        const selectedPackage = latestConstruction?.selectedPackage || "";
        const finalPackageCost =
            latestConstruction?.finalPackageCost ||
            latestConstruction?.totalPackageCost ||
            project.contractValue ||
            0;

        const contractValueNumber = Number(project.contractValue || finalPackageCost || 0);
        const contractValueInr = contractValueNumber
            ? contractValueNumber.toLocaleString("en-IN")
            : "â€”";

        const subject = `99Squarewall | Agreement for Your Home Construction Project (${project.projectId})`;

        const html = `
      <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; font-size: 15px; color: #111827; line-height: 1.6;">
        <p>Hi ${clientName},</p>

        <p>
          Thank you for choosing <strong>99Squarewall</strong> for your home construction.
          Based on your <strong>approved estimate</strong> and discussions with our team,
          we have prepared your <strong>Construction Agreement</strong> for review and e-signature.
        </p>

        <div style="margin: 16px 0; padding: 14px 16px; background:#F3F4FF; border-radius: 10px; border:1px solid #E0E3FF;">
          <div style="font-weight:600; margin-bottom:8px;">Project Summary</div>
          <table style="width:100%; font-size:14px; border-collapse:collapse;">
            <tr>
              <td style="padding:4px 0; width:38%; color:#4B5563;">Project ID</td>
              <td style="padding:4px 0;">${project.projectId || ""}</td>
            </tr>
            <tr>
              <td style="padding:4px 0; color:#4B5563;">Project Title</td>
              <td style="padding:4px 0;">${project.projectTitle || ""}</td>
            </tr>
            <tr>
              <td style="padding:4px 0; color:#4B5563;">Site Address</td>
              <td style="padding:4px 0;">${project.siteAddress || plot.plotLocation || ""}</td>
            </tr>
            <tr>
              <td style="padding:4px 0; color:#4B5563;">Plot Area</td>
              <td style="padding:4px 0;">${areaOfPlot || "As per approved estimate"}</td>
            </tr>
            <tr>
              <td style="padding:4px 0; color:#4B5563;">Configuration</td>
              <td style="padding:4px 0;">${configurationName || project.projectType || "Residential"}</td>
            </tr>
            <tr>
              <td style="padding:4px 0; color:#4B5563;">Selected Package</td>
              <td style="padding:4px 0;">${selectedPackage || "As per estimate (RAQCS-compliant package)"}</td>
            </tr>
            <tr>
              <td style="padding:4px 0; color:#4B5563;">Contract Value</td>
              <td style="padding:4px 0;">â‚¹ ${contractValueInr}/- (incl. construction scope as per attached terms)</td>
            </tr>
          </table>
        </div>

        <p>
          The agreement covers:
        </p>
        <ul style="padding-left:20px; margin-top:8px;">
          <li>Approved <strong>construction package & specifications</strong> for your home</li>
          <li><strong>Project location & plot details</strong> as per your shared information</li>
          <li><strong>Payment schedule & milestones</strong> linked to construction stages</li>
          <li><strong>Quality & compliance standards</strong> under the 99Squarewall RAQCS framework</li>
        </ul>

        <p style="margin-top:16px;">
          Please review the agreement carefully and provide your e-signature to confirm.
          Once you sign, your project will move to <strong>Project Started</strong> status
          and our team will begin the pre-construction readiness steps.
        </p>

        <p style="margin: 24px 0; text-align: center;">
          <a href="${signingUrl}"
             style="
               display: inline-block;
               padding: 12px 24px;
               background: #004AAD;
               color: #ffffff;
               text-decoration: none;
               border-radius: 999px;
               font-weight: 600;
             ">
            Review & Sign Agreement
          </a>
        </p>

        <p style="font-size: 14px; color: #4B5563;">
          If the button doesnâ€™t work, copy and paste this link into your browser:<br />
          <span style="word-break: break-all; color: #2563EB;">
            ${signingUrl}
          </span>
        </p>

        <hr style="border: none; border-top: 1px solid #E5E7EB; margin: 24px 0;" />

        <p style="font-size: 13px; color: #6B7280;">
          If anything in the agreement looks different from what you discussed with our team,
          please reply to this email or connect with your Relationship Manager before signing.
        </p>

        <p style="margin-top: 16px;">
          Warm regards,<br />
          <strong>99Squarewall</strong><br />
          Home Construction Company
        </p>
      </div>
    `;

        const text = `
Hi ${clientName},

Thank you for choosing 99Squarewall for your home construction.

Based on the approved estimate, we have prepared your Construction Agreement with:

- Project: ${project.projectTitle || project.projectId}
- Site: ${project.siteAddress || plot.plotLocation || ""}
- Package: ${selectedPackage || "As per approved estimate"}
- Contract Value: â‚¹${contractValueInr}/-

Please open this link to review and sign the agreement:

${signingUrl}

Once you submit the agreement, your project will be marked as Started in our system.

If you need any clarification before signing, just reply to this email.

Warm regards,
99Squarewall
Home Construction Company
    `.trim();

        const attachments = [];
        // Optionally attach initial agreement / estimate PDF later from project.agreement.initialPdfUrl

        await sendMailWithAttachments({
            to: client.email,
            subject,
            html,
            text,
            attachments,
        });

        // Update project status + sentAt
        project.status = "agreement_sent";
        project.agreement.sentAt = new Date();
        await project.save();

        // Align user phase (idempotent)
        try {
            client.currentPhase = "Agreement & Booking Payment";
            if (Array.isArray(client.steps)) {
                const agrIndex = client.steps.findIndex(
                    (s) => s.title === "Agreement & booking payment"
                );
                if (agrIndex !== -1) {
                    client.steps[agrIndex].status = "ongoing-stage";
                }
            }
            await client.save();
        } catch (e) {
            console.warn("sendAgreementEmail: failed to update client", e);
        }

        // Activity log
        try {
            await logActivity(project, {
                type: "agreement.sent",
                name: "Agreement Sent",
                description: `Agreement email sent to ${client.email}`,
                actor: { name: "System", actorType: "system" },
            });
        } catch (e) {
            console.warn("sendAgreementEmail: failed to log activity", e);
        }

        return res.status(200).json({
            ok: true,
            message: "Agreement email sent successfully.",
            project,
        });
    } catch (err) {
        console.error("sendAgreementEmail error:", err);
        return res.status(500).json({
            ok: false,
            message: "Something went wrong while sending the agreement email.",
        });
    }
};


/**
 * GET /api/public/agreement/preview?token=...&projectId=...
 *
 * Used by frontend agreement page to load project + client info.
 * No auth â€“ protected by secret token.
 */
export const previewAgreement = async (req, res) => {
    try {
        const { token, projectId } = req.query;

        if (!token || !projectId) {
            return res
                .status(400)
                .json({ ok: false, message: "Missing token or projectId." });
        }

        const project = await Project.findOne({
            _id: projectId,
            "agreement.token": token,
        }).lean();

        if (!project) {
            return res
                .status(404)
                .json({ ok: false, message: "Agreement not found or link is invalid." });
        }

        if (project.agreement?.acceptedAt) {
            return res.status(400).json({
                ok: false,
                code: "ALREADY_ACCEPTED",
                message: "This agreement has already been accepted.",
            });
        }

        const client = await User.findById(project.clientId).lean();

        const plot = project.plotInformation || {};
        const latestConstruction =
            Array.isArray(project.constructionDetails) &&
                project.constructionDetails.length
                ? project.constructionDetails[project.constructionDetails.length - 1]
                : null;

        const totalAmount =
            project.contractValue ||
            latestConstruction?.finalPackageCost ||
            latestConstruction?.totalPackageCost ||
            0;

        return res.json({
            ok: true,
            data: {
                projectId: project._id,
                projectName: project.projectTitle || project.projectId,
                siteAddress: project.siteAddress || plot.plotLocation || "",
                totalAmount,
                status: project.status,
                clientName:
                    client?.fullName ||
                    client?.name ||
                    client?.username ||
                    `${client?.firstName || ""} ${client?.lastName || ""}`.trim() ||
                    "",
                clientEmail: client?.email || "",
                sentAt: project.agreement?.sentAt || null,
                plot: {
                    areaOfPlot: plot.areaOfPlot || "",
                    length: plot.length || "",
                    breadth: plot.breadth || "",
                    location: plot.plotLocation || "",
                },
                package: {
                    selectedPackage: latestConstruction?.selectedPackage || "",
                    finalPackageCost:
                        latestConstruction?.finalPackageCost ||
                        latestConstruction?.totalPackageCost ||
                        "",
                    configurationName:
                        latestConstruction?.configurationName || project.projectType,
                },
            },
        });
    } catch (err) {
        console.error("previewAgreement error:", err);
        return res.status(500).json({
            ok: false,
            message: "Something went wrong while loading the agreement.",
        });
    }
};


/**
 * Generate a simple signed agreement PDF.
 * Later you can make it fully branded with logo, RAQCS, etc.
 *
 * Returns: { filePath, publicUrl }
 */
async function generateSignedAgreementPdf({ project, client, signer, estimate, signatureData, acceptedAt }) {
    const outDir = path.join(process.cwd(), "storage", "agreements");
    if (!fs.existsSync(outDir)) fs.mkdirSync(outDir, { recursive: true });

    const fileName = `agreement-${project._id}-${Date.now()}.pdf`;
    const filePath = path.join(outDir, fileName);

    // Decode base64 signature image (data URL -> Buffer)
    let signatureImageBuffer = null;
    if (signatureData && typeof signatureData === "string") {
        try {
            const base64 = signatureData.replace(/^data:image\/\w+;base64,/, "");
            signatureImageBuffer = Buffer.from(base64, "base64");
        } catch (e) {
            console.warn("generateSignedAgreementPdf: failed to parse signatureData", e);
        }
    }

    const acceptedAtDate = acceptedAt instanceof Date ? acceptedAt : new Date();

    return new Promise((resolve, reject) => {
        const doc = new PDFDocument({
            margin: 60,
            autoFirstPage: true,
        });
        const stream = fs.createWriteStream(filePath);

        doc.pipe(stream);

        // ---------- COMMON DATA ----------
        const today = new Date();
        const agreementDate = today.toLocaleDateString("en-GB"); // 29/07/2025

        const city =
            project.clientCity ||
            (project.siteAddress && project.siteAddress.split(",").pop()?.trim()) ||
            "Pune";

        const plot = project.plotInformation || {};
        const latestConstruction =
            Array.isArray(project.constructionDetails) &&
                project.constructionDetails.length
                ? project.constructionDetails[project.constructionDetails.length - 1]
                : null;

        console.log('latestConstruction:', project);

        const total =
            project.contractValue ||
            latestConstruction?.finalPackageCost ||
            latestConstruction?.totalPackageCost ||
            project.totalAmount ||
            0;

        const contractValueInr = Number(total || 0).toLocaleString("en-IN");

        const clientName =
            client?.fullName ||
            client?.name ||
            client?.username ||
            `${client?.firstName || ""} ${client?.lastName || ""}`.trim() ||
            "Client";

        const siteAddress = project.siteAddress || plot.plotLocation || "";
        const areaOfPlot = plot.areaOfPlot || "";
        const configurationName =
            latestConstruction?.configurationName || project.projectType || "Residential";

        // ---- NEW: resolve selected package + categories from constructionDetails ----
        const selectedPackageLabel = latestConstruction?.selectedPackage || "";
        const packageDetailsArray = Array.isArray(latestConstruction?.packageDetails)
            ? latestConstruction.packageDetails
            : [];

        // Try to pick the exact package row; fallback to the first one
        const selectedPackageRow =
            packageDetailsArray.find(p =>
                p?.packageName === selectedPackageLabel ||
                String(p?.price) === String(selectedPackageLabel) ||
                String(p?.packagePrice) === String(selectedPackageLabel)
            ) || packageDetailsArray[0] || null;

        const specCategories = Array.isArray(selectedPackageRow?.categories)
            ? selectedPackageRow.categories
            : [];

        // Floors array (for overview)
        const overviewFloors = Array.isArray(latestConstruction?.floors)
            ? latestConstruction.floors
            : [];

        const perFt2Rate = Number(latestConstruction?.selectedPackage) || 0;
        const plinthArea = Number(latestConstruction?.plinthBuiltUpArea) || 0;

        // Simple total built-up (like EstimateDetails): sum floor areas, fallback to plotArea
        const totalBuiltArea = overviewFloors.reduce((sum, f) => {
            const a = Number(f?.area) || 0;
            const b = Number(f?.balconyArea) || 0;
            return sum + a + b;
        }, 0) || Number(latestConstruction?.plotArea) || 0;

        const pageWidth =
            doc.page.width - doc.page.margins.left - doc.page.margins.right;

        // ==========================================================
        // HELPERS: Specification & Construction Overview pages
        // ==========================================================

        function renderConstructionSpecificationPage() {
            if (!specCategories.length) return;

            doc.addPage({ margin: 60 });

            // Main title like estimate: "A - Basic Package For Construction Project"
            doc
                .font("fonts/Asap-Bold.ttf")
                .fontSize(14)
                .text(
                    selectedPackageRow?.packageName
                        ? `${selectedPackageRow.packageName} â€“ Construction Specification`
                        : "Construction Specification",
                    {
                        align: "center",
                        width: pageWidth,
                    }
                )
                .moveDown(0.2);

            doc
                .font("fonts/Asap-Regular.ttf")
                .fontSize(10.5)
                .text("Specification & Quotation for Turnkey Construction Project", {
                    align: "center",
                    width: pageWidth,
                })
                .moveDown(1.0);

            // Small yellow underline bar (centered)
            const underlineWidth = 60;
            const underlineX = doc.x + (pageWidth - underlineWidth) / 2;
            const underlineY = doc.y;
            doc
                .save()
                .rect(underlineX, underlineY, underlineWidth, 3)
                .fill("#FFC727")
                .restore();
            doc.moveDown(1.4);

            // Numbered items across categories (global index)
            let globalIndex = 1;

            specCategories.forEach((cat, catIdx) => {
                const catTitle =
                    cat?.category || cat?.name || `Specification Group ${catIdx + 1}`;

                // Category heading band
                doc
                    .moveDown(catIdx === 0 ? 0 : 0.8)
                    .font("fonts/Asap-Bold.ttf")
                    .fontSize(11)
                    .fillColor("#0037FF")
                    .text(catTitle.toUpperCase(), {
                        width: pageWidth,
                    })
                    .moveDown(0.15);

                // thin grey line under heading
                const lineY = doc.y;
                doc
                    .save()
                    .moveTo(doc.x, lineY)
                    .lineTo(doc.x + pageWidth, lineY)
                    .lineWidth(0.8)
                    .stroke("#CBD5F5")
                    .restore();
                doc.moveDown(0.4);

                const details = Array.isArray(cat?.details) ? cat.details : [];

                details.forEach((d) => {
                    const heading = d?.heading || "Item";
                    const descriptionRaw = d?.description;
                    const deliverablesRaw = d?.deliverables;

                    const descArray = Array.isArray(descriptionRaw)
                        ? descriptionRaw.filter(Boolean).map(String)
                        : descriptionRaw
                            ? [String(descriptionRaw)]
                            : [];

                    const deliverablesArray = Array.isArray(deliverablesRaw)
                        ? deliverablesRaw.filter(Boolean).map(String)
                        : [];

                    // Item heading: "1. Architectural Floor Plan"
                    doc
                        .font("fonts/Asap-Bold.ttf")
                        .fontSize(10.5)
                        .fillColor("#111827")
                        .text(`${globalIndex}. ${heading}`, {
                            width: pageWidth,
                        });
                    globalIndex += 1;

                    // Description bullets
                    if (descArray.length) {
                        doc
                            .moveDown(0.1)
                            .font("fonts/Asap-Regular.ttf")
                            .fontSize(10)
                            .fillColor("#111827");
                        descArray.forEach((line) => {
                            doc.text(`â€¢ ${line}`, {
                                width: pageWidth,
                                indent: 12,
                            });
                        });
                    }

                    // Deliverables
                    if (deliverablesArray.length) {
                        doc
                            .moveDown(0.25)
                            .font("fonts/Asap-Bold.ttf")
                            .fontSize(9.5)
                            .fillColor("#111827")
                            .text("Deliverables:", {
                                width: pageWidth,
                                indent: 6,
                            });

                        doc
                            .font("fonts/Asap-Regular.ttf")
                            .fontSize(10)
                            .fillColor("#111827");

                        deliverablesArray.forEach((line) => {
                            doc.text(`â€¢ ${line}`, {
                                width: pageWidth,
                                indent: 14,
                            });
                        });
                    }

                    doc.moveDown(0.6);
                });
            });

            // NOTE (same intent as EstimateDetails spec page)
            doc
                .moveDown(0.4)
                .font("fonts/Asap-Regular.ttf")
                .fontSize(9.5)
                .fillColor("#4B5563")
                .text(
                    "NOTE: The above specification and quotation cover the turnkey construction scope as discussed and approved. Any work beyond this scope (for example, compound wall, full pergola, custom furniture, modular kitchen, or other add-ons) will be treated as extra and will be charged separately as per actual design and site conditions.",
                    {
                        width: pageWidth,
                        align: "justify",
                    }
                );
        }

        function renderConstructionOverviewPage() {
            // We prefer Estimate (authoritative), but still fallback to constructionDetails if needed
            const hasEstimate = !!estimate;

            const latestConstruction =
                Array.isArray(project.constructionDetails) &&
                    project.constructionDetails.length
                    ? project.constructionDetails[project.constructionDetails.length - 1]
                    : null;

            // --- Pull from Estimate (authoritative) ---
            const estRec = hasEstimate ? (estimate.recommendation || {}) : {};
            const estPricing = hasEstimate ? (estimate.pricing || {}) : {};

            const areaFt2FromEstimate = Number(estRec.areaFt2 || 0);
            const plinthAreaFt2FromEstimate = Number(estRec.plinthAreaFt2 || 0);
            const headRoomAreaFt2FromEstimate = Number(estRec.headRoomAreaFt2 || 0);

            const perFt2FromEstimate = Number(estPricing.perFt2 || estRec.perFt2Base || 0);
            const plinthRateFromEstimate = Number(estRec.plinthRate || 0);
            const headRateFromEstimate = Number(estRec.headRoomRate || perFt2FromEstimate || 0);

            const baseAmtFromEstimate = Number(estPricing.base || 0);
            const plinthAmtFromEstimate = Number(estPricing.plinthAmt || 0);
            const headAmtFromEstimate = Number(estPricing.headAmt || 0);

            // --- Fallbacks from constructionDetails (if something missing on Estimate) ---
            const overviewFloors = Array.isArray(latestConstruction?.floors)
                ? latestConstruction.floors
                : [];

            const plinthAreaFromConstruction = Number(latestConstruction?.plinthBuiltUpArea || 0);
            const plotAreaFromConstruction = Number(latestConstruction?.plotArea || 0);

            // Summed built-up from floors (area + balconyArea)
            const totalBuiltAreaFromFloors = overviewFloors.reduce((sum, f) => {
                const a = Number(f?.area || 0);
                const b = Number(f?.balconyArea || 0);
                return sum + a + b;
            }, 0);

            // Final *chargeable* area we show in card
            const effectiveAreaFt2 =
                areaFt2FromEstimate ||
                totalBuiltAreaFromFloors ||
                plotAreaFromConstruction ||
                0;

            // Final per-ftÂ² rate we show in card
            const effectiveRatePerFt2 =
                perFt2FromEstimate ||
                Number(latestConstruction?.perFt2Rate || 0) ||
                Number(latestConstruction?.selectedPackage || 0) || // last-resort, in case you ever store a raw number here
                0;

            // Use your existing contractValueInr (already computed above from contractValue / finalPackageCost / totalPackageCost)
            // const contractValueInr = ...

            // If we have neither estimate nor constructionDetails, don't render the page
            if (!effectiveAreaFt2 && !hasEstimate && !latestConstruction) return;

            doc.addPage({ margin: 60 });

            // --- TITLES ---
            doc
                .font("fonts/Asap-Bold.ttf")
                .fontSize(14)
                .fillColor("#111827")
                .text("CONSTRUCTION OVERVIEW", {
                    align: "center",
                    width: pageWidth,
                })
                .moveDown(0.6);

            const projectCode = project.projectId || project.projectTitle || "";

            doc
                .font("fonts/Asap-Regular.ttf")
                .fontSize(10.5)
                .fillColor("#111827")
                .text(
                    projectCode
                        ? `For Project: ${projectCode}`
                        : "Approved construction scope and costing overview",
                    {
                        align: "center",
                        width: pageWidth,
                    }
                )
                .moveDown(1.0);

            // --- INTRO TEXT ---
            doc
                .font("fonts/Asap-Regular.ttf")
                .fontSize(10)
                .fillColor("#4B5563")
                .text(
                    "This overview is based on the approved estimate and package selected for your project. It shows area-wise breakup, applicable construction rate and the corresponding values considered in the contract value.",
                    {
                        width: pageWidth,
                        align: "justify",
                    }
                )
                .moveDown(1.0);

            // --- TOP SUMMARY CARD ---
            const metrics = [
                {
                    label: "Total Built-Up / Chargeable Area",
                    value: effectiveAreaFt2
                        ? `${effectiveAreaFt2.toLocaleString("en-IN")} sq.ft`
                        : "As per approved drawings",
                },
                {
                    label: "Base Construction Rate (Package Rate)",
                    value: effectiveRatePerFt2
                        ? `â‚¹ ${effectiveRatePerFt2.toLocaleString("en-IN")}/sq.ft`
                        : "As per selected package",
                },
                {
                    label: "Contract Value (Before GST)",
                    value: `â‚¹ ${contractValueInr}/-`,
                },
            ];

            const cardY = doc.y;
            const metricRowHeight = 16;

            doc
                .save()
                .rect(doc.x, cardY - 6, pageWidth, metricRowHeight * metrics.length + 12)
                .fill("#F3F4FF")
                .restore();

            doc
                .font("fonts/Asap-Bold.ttf")
                .fontSize(10.5)
                .fillColor("#111827");

            let metricY = cardY;
            metrics.forEach((m) => {
                doc.text(m.label, doc.x + 8, metricY, {
                    width: pageWidth / 2 - 10,
                });
                doc.text(m.value, doc.x + pageWidth / 2, metricY, {
                    width: pageWidth / 2 - 10,
                    align: "right",
                });
                metricY += metricRowHeight;
            });

            doc.y = metricY + 18;

            // --- TABLE TITLE ---
            doc
                .font("fonts/Asap-Bold.ttf")
                .fontSize(11)
                .fillColor("#111827")
                .text("Area-wise Costing Snapshot", {
                    width: pageWidth,
                })
                .moveDown(0.6);

            // ---- BUILD ROW DATA ----
            const rows = [];

            // 1) Main built-up (from Estimate)
            if (areaFt2FromEstimate && effectiveRatePerFt2) {
                rows.push({
                    label: "Construction Built-Up Area",
                    qty: `${areaFt2FromEstimate.toLocaleString("en-IN")} sq.ft`,
                    rate: `â‚¹ ${effectiveRatePerFt2.toLocaleString("en-IN")}/sq.ft`,
                    cost: baseAmtFromEstimate
                        ? `â‚¹ ${baseAmtFromEstimate.toLocaleString("en-IN")}/-`
                        : "Included in package value",
                });
            }

            // 2) Plinth (from Estimate; fallback to constructionDetails)
            const plinthAreaEffective =
                plinthAreaFt2FromEstimate || plinthAreaFromConstruction || 0;
            const plinthRateEffective =
                plinthRateFromEstimate || effectiveRatePerFt2 || 0;
            const plinthAmtEffective =
                plinthAmtFromEstimate ||
                (plinthAreaEffective && plinthRateEffective
                    ? plinthAreaEffective * plinthRateEffective
                    : 0);

            if (plinthAreaEffective) {
                rows.push({
                    label: "Plinth / Ground Floor Built-Up Area",
                    qty: `${plinthAreaEffective.toLocaleString("en-IN")} sq.ft`,
                    rate: plinthRateEffective
                        ? `â‚¹ ${plinthRateEffective.toLocaleString("en-IN")}/sq.ft`
                        : "As per package",
                    cost: plinthAmtEffective
                        ? `â‚¹ ${plinthAmtEffective.toLocaleString("en-IN")}/-`
                        : "Included in package value",
                });
            }

            // 3) Head Room (if any recorded in estimate)
            if (headRoomAreaFt2FromEstimate) {
                const headAmtEffective =
                    headAmtFromEstimate ||
                    (headRoomAreaFt2FromEstimate && headRateFromEstimate
                        ? headRoomAreaFt2FromEstimate * headRateFromEstimate
                        : 0);

                rows.push({
                    label: "Head Room Built-Up Area",
                    qty: `${headRoomAreaFt2FromEstimate.toLocaleString("en-IN")} sq.ft`,
                    rate: headRateFromEstimate
                        ? `â‚¹ ${headRateFromEstimate.toLocaleString("en-IN")}/sq.ft`
                        : "As per package",
                    cost: headAmtEffective
                        ? `â‚¹ ${headAmtEffective.toLocaleString("en-IN")}/-`
                        : "Included in package value",
                });
            }

            // 4) If thereâ€™s no estimate-level breakup, fallback to floors
            if (!rows.length && overviewFloors.length && effectiveRatePerFt2) {
                overviewFloors.forEach((f, idx) => {
                    const a = Number(f?.area || 0);
                    if (!a) return;

                    let floorLabel;
                    if (idx === 0) floorLabel = "Parking / Ground Floor";
                    else if (idx === 1) floorLabel = "First Floor";
                    else if (idx === 2) floorLabel = "Second Floor";
                    else if (idx === 3) floorLabel = "Third Floor";
                    else floorLabel = `Floor ${idx + 1}`;

                    rows.push({
                        label: floorLabel,
                        qty: `${a.toLocaleString("en-IN")} sq.ft`,
                        rate: `â‚¹ ${effectiveRatePerFt2.toLocaleString("en-IN")}/sq.ft`,
                        cost: `â‚¹ ${(a * effectiveRatePerFt2).toLocaleString("en-IN")}/-`,
                    });
                });
            }

            // 5) Ultimate fallback: single row with total area + contract value
            if (!rows.length && effectiveAreaFt2) {
                rows.push({
                    label: "Total Built-Up Area (Package)",
                    qty: `${effectiveAreaFt2.toLocaleString("en-IN")} sq.ft`,
                    rate: effectiveRatePerFt2
                        ? `â‚¹ ${effectiveRatePerFt2.toLocaleString("en-IN")}/sq.ft`
                        : "As per package",
                    cost: `â‚¹ ${contractValueInr}/-`,
                });
            }

            const tableData = [
                ["S. No.", "Item", "Rate", "Quantity / Area", "Total Cost (INR)"],
                ...rows.map((row, i) => [
                    String(i + 1),
                    row.label,
                    row.rate,
                    row.qty,
                    row.cost,
                ]),
            ];

            doc.moveDown(0.5);

            doc.table({
                data: tableData,
                maxWidth: pageWidth,
                position: { x: doc.x, y: doc.y },
                defaultStyle: {
                    fontSize: 9.5,
                    padding: 4,
                    borderColor: "#E5E7EB",
                },
                columnStyles: [
                    { width: 40, align: { x: "left", y: "center" } },
                    { width: "*", align: { x: "left", y: "top" } },
                    { width: 90, align: { x: "right", y: "center" } },
                    { width: 90, align: { x: "right", y: "center" } },
                    { width: 110, align: { x: "right", y: "center" } },
                ],
                rowStyles: (rowIndex) => {
                    if (rowIndex === 0) {
                        return {
                            backgroundColor: "#0037FF",
                            textColor: "#FFFFFF",
                            font: "fonts/Asap-Bold.ttf",
                            align: { x: "center", y: "center" },
                            border: [0, 0, 1, 0],
                            borderColor: "#0037FF",
                        };
                    }
                    if (rowIndex % 2 === 1) {
                        return {
                            backgroundColor: "#F9FAFB",
                        };
                    }
                    return {};
                },
            });

            doc.moveDown(1.0);

            doc
                .font("fonts/Asap-Regular.ttf")
                .fontSize(9.5)
                .fillColor("#4B5563")
                .text(
                    "Note: The above area-wise values are part of the single turnkey construction package agreed for this project. Any change in drawings, built-up area or scope will be discussed and mutually agreed, and may result in a revised estimate or variation order.",
                    {
                        width: pageWidth,
                        align: "justify",
                    }
                );
        }

        function renderTermsAndConditionsPage() {
            doc.addPage({ margin: 60 });

            // Main heading
            doc
                .font("fonts/Asap-Bold.ttf")
                .fontSize(14)
                .fillColor("#111827")
                .text("TERMS & CONDITIONS", {
                    align: "center",
                    width: pageWidth,
                })
                .moveDown(0.6);

            doc
                .font("fonts/Asap-Regular.ttf")
                .fontSize(10)
                .fillColor("#4B5563")
                .text(
                    "These Terms & Conditions form an integral part of the construction agreement between the OWNER and 99Squarewall Home Construction Company for turnkey execution of the above-mentioned residential project.",
                    {
                        width: pageWidth,
                        align: "justify",
                    }
                )
                .moveDown(0.8);

            const addClause = (title, body) => {
                doc
                    .font("fonts/Asap-Bold.ttf")
                    .fontSize(10.5)
                    .fillColor("#111827")
                    .text(title, {
                        width: pageWidth,
                    })
                    .moveDown(0.15);

                doc
                    .font("fonts/Asap-Regular.ttf")
                    .fontSize(10)
                    .fillColor("#4B5563")
                    .text(body, {
                        width: pageWidth,
                        align: "justify",
                    })
                    .moveDown(0.6);
            };

            // 1. Scope of Work
            addClause(
                "1. SCOPE OF WORK",
                `The BUILDING CONTRACTOR shall execute turnkey civil construction of the residential building at ${siteAddress || "the project site"} on the plot measuring ${areaOfPlot || "the plot area as per approved drawings"}, strictly as per the approved architectural and structural drawings, construction package, specifications and estimate shared with the OWNER (collectively referred to as the â€œApproved Scopeâ€). Any work not expressly mentioned in the Approved Scope (including but not limited to compound wall, full pergola, extensive landscaping, modular kitchen, furniture, or special custom items) shall be treated as extra work and will be executed only upon written confirmation from the OWNER and on additional mutually agreed charges.`
            );

            // 2. Drawings, Approvals & Statutory Compliance
            addClause(
                "2. DRAWINGS, APPROVALS & STATUTORY COMPLIANCE",
                `The construction shall be carried out as per the sanctioned drawings, bye-laws and applicable rules of the competent authority. Unless otherwise expressly agreed in writing, the OWNER shall be responsible for obtaining all necessary approvals, permissions, sanctions and clearances required from local authorities. The BUILDING CONTRACTOR will provide technical support and documentation as reasonably required. Any deviation required in sanctioned drawings or change in configuration shall be discussed, re-estimated where necessary, and shall be implemented only after written approval of the OWNER.`
            );

            // 3. Quality, RAQCS & Materials
            addClause(
                "3. QUALITY, RAQCS & MATERIALS",
                "All works shall be executed in accordance with the 99Squarewall RAQCS (Rapid Quality & Compliance System) framework and the mutually agreed specifications. Branded materials of acceptable quality shall be used as per the package selected by the OWNER. The BUILDING CONTRACTOR shall maintain stage-wise quality checks, site photographs and checklists. Any material or workmanship found to be below agreed standards shall be rectified by the BUILDING CONTRACTOR at its own cost, provided such non-conformance is due to its scope. Any request by the OWNER to substitute specified materials with alternate brands / makes may affect the cost and shall be recorded as a variation."
            );

            // 4. Project Schedule & Delays
            addClause(
                "4. PROJECT SCHEDULE & DELAYS",
                "An indicative construction schedule shall be shared with the OWNER at the time of project kick-off and may be updated during the course of execution. The completion timeline is dependent on timely statutory approvals, site readiness, uninterrupted access, timely payments and decisions by the OWNER. Delays arising from reasons beyond the reasonable control of the BUILDING CONTRACTOR (including but not limited to force majeure events, extended monsoon, labour unrest, material shortages, sudden changes in law, pandemic related restrictions, or delays in approvals or decisions by the OWNER) shall result in a reasonable extension of time without any penalty on the BUILDING CONTRACTOR."
            );

            // 5. Payment Terms & Taxes
            addClause(
                "5. PAYMENT TERMS & TAXES",
                "The OWNER agrees to release payments strictly as per the milestone-based payment schedule linked to construction stages / RAQCS checkpoints shared by 99Squarewall and annexed with this agreement and the approved estimate. All payments shall be made in favour of the BUILDING CONTRACTOR through banking channels only. Applicable taxes (such as GST) shall be payable extra as per prevailing law unless specifically stated otherwise. In case of delay in payment beyond the agreed due dates, the BUILDING CONTRACTOR shall be entitled to slow down or temporarily suspend work without prejudice to its other rights, and may charge interest on delayed amounts as per mutually agreed terms."
            );

            // 6. Variations, Extra Items & Change Requests
            addClause(
                "6. VARIATIONS, EXTRA ITEMS & CHANGE REQUESTS",
                "Any change in design, layout, specification, area, package, finishes or scope requested by the OWNER after finalisation of the Approved Scope shall be treated as a variation. All variations / extra items shall be recorded in writing or via the 99Squarewall digital platform / app and shall clearly mention the impact on cost and time. The BUILDING CONTRACTOR shall proceed with such variation work only after obtaining written / digital approval from the OWNER. All approved variations shall form part of this agreement and be payable by the OWNER as per the agreed terms."
            );

            // 7. Site Access, Safety & Owner Responsibilities
            addClause(
                "7. SITE ACCESS, SAFETY & OWNER RESPONSIBILITIES",
                "The OWNER shall provide unhindered access to the site during working hours along with space for safe material storage. The OWNER shall arrange, at its cost unless otherwise agreed, basic water and electricity required for construction or reimburse the same to the BUILDING CONTRACTOR as mutually decided. The BUILDING CONTRACTOR shall take reasonable care for site safety, barricading and housekeeping within its scope. The OWNER shall not permit any third-party contractor to carry out overlapping construction work at the same site without written coordination with the BUILDING CONTRACTOR, as such interference may compromise quality, safety and accountability."
            );

            // 8. Defects Liability & Warranty
            addClause(
                "8. DEFECTS LIABILITY & WARRANTY",
                "Post completion and handover, the BUILDING CONTRACTOR shall provide a structured defects liability support for a defined period in line with 99Squarewall policies for the respective package (for example, a longer warranty on structural elements and waterproofing, and a limited period warranty on internal finishes). This coverage shall be strictly for workmanship and material defects falling under the BUILDING CONTRACTORâ€™s scope. Issues arising due to normal wear and tear, misuse, lack of maintenance, alterations by third parties, or external factors (such as extreme weather, waterlogging beyond design assumptions, or acts of third parties) shall not be covered. Detailed warranty and HomeCare / RAQCS support terms, if applicable, shall be provided separately and shall be read along with this clause."
            );

            // 9. Handover & Possession
            addClause(
                "9. HANDOVER & POSSESSION",
                "The project shall be treated as substantially complete once the agreed scope of civil construction is completed and the building is fit for occupation, subject to minor snag rectifications. Formal handover shall be done upon settlement of all dues payable to the BUILDING CONTRACTOR under this agreement. At the time of handover, 99Squarewall will share a summary of RAQCS stage reports / key checklists and a snapshot of the as-built status to the OWNER. Any balance or retention, if agreed, shall be as per the mutually agreed payment terms."
            );

            // 10. Suspension, Termination & Consequences
            addClause(
                "10. SUSPENSION, TERMINATION & CONSEQUENCES",
                "In the event of (i) persistent non-payment by the OWNER, (ii) material breach of obligations by either party, or (iii) prolonged site inaccessibility not attributable to the BUILDING CONTRACTOR, the affected party may seek to suspend or terminate the agreement after providing reasonable written notice and an opportunity to cure the breach, where practical. Upon termination, the BUILDING CONTRACTOR shall be entitled to payment for all work executed up to the effective date of termination, including duly approved variations, materials already procured for the project and any demobilisation costs, as mutually reconciled."
            );

            // 11. Force Majeure
            addClause(
                "11. FORCE MAJEURE",
                "Neither party shall be liable for failure or delay in performance of its obligations under this agreement if such failure or delay is due to events beyond its reasonable control, including but not limited to natural calamities, pandemic, war, strikes, governmental restrictions, or major disruptions in supply chains. In such cases, both parties shall, in good faith, discuss revised timelines and practical steps to resume work."
            );

            // 12. Dispute Resolution & Jurisdiction
            addClause(
                "12. DISPUTE RESOLUTION & JURISDICTION",
                `The parties shall endeavour to resolve any dispute arising out of or in connection with this agreement through mutual discussion in good faith. If the dispute remains unresolved, the same may, by mutual consent, be referred to arbitration in accordance with the applicable law in India. The place of arbitration and the exclusive jurisdiction for all matters arising herefrom shall be courts at ${city}.`
            );

            // 13. Entire Agreement & Amendments
            addClause(
                "13. ENTIRE AGREEMENT & AMENDMENTS",
                "This agreement, together with the approved drawings, estimate, package specifications, payment schedule and any written variation orders, constitutes the entire understanding between the OWNER and the BUILDING CONTRACTOR in respect of the construction scope described herein and supersedes all prior verbal understandings on the same subject. Any amendment or modification to this agreement shall be valid only if recorded in writing or via the 99Squarewall digital platform / app and acknowledged by both parties."
            );
        }

        function renderAcceptancePage() {
            doc.addPage({ margin: 60 });

            // Heading
            doc
                .font("fonts/Asap-Bold.ttf")
                .fontSize(14)
                .fillColor("#111827")
                .text("ACCEPTANCE & SIGNATURE", {
                    align: "center",
                    width: pageWidth,
                })
                .moveDown(0.8);

            // Short intro
            doc
                .font("fonts/Asap-Regular.ttf")
                .fontSize(10)
                .fillColor("#4B5563")
                .text(
                    "By signing below, the OWNER confirms that they have read and understood the Agreement and the Terms & Conditions and agree to proceed with the construction as per the approved scope, specifications and payment schedule.",
                    {
                        width: pageWidth,
                        align: "justify",
                    }
                )
                .moveDown(1.0);

            const ownerDisplayName =
                (signer && signer.name) ||
                clientName;

            const colWidth = pageWidth * 0.55;
            const boxX = doc.x;
            const boxY = doc.y;

            // Owner block
            doc
                .font("fonts/Asap-Bold.ttf")
                .fontSize(11)
                .fillColor("#111827")
                .text("OWNER (CLIENT)", boxX, boxY, {
                    width: colWidth,
                })
                .moveDown(0.4);

            doc
                .font("fonts/Asap-Regular.ttf")
                .fontSize(10)
                .fillColor("#111827")
                .text(`Name: ${ownerDisplayName}`, {
                    width: colWidth,
                })
                .moveDown(0.3);

            const sigLineY = doc.y + 24;

            // Signature label + line
            doc.text("Signature:", {
                width: colWidth,
            });

            // Draw signature line baseline
            const lineStartX = boxX + 70;
            const lineEndX = boxX + colWidth - 10;
            const lineY = doc.y + 4;

            doc
                .save()
                .moveTo(lineStartX, lineY)
                .lineTo(lineEndX, lineY)
                .lineWidth(0.7)
                .stroke("#9CA3AF")
                .restore();

            // Place signature image ON the line (owned by user)
            if (signatureImageBuffer) {
                doc.save();
                try {
                    doc.image(signatureImageBuffer, lineStartX + 5, lineY - 50, {
                        fit: [160, 50],
                    });
                } catch (e) {
                    console.warn("PDF: failed to embed signature image", e);
                }
                doc.restore();
            }

            doc.moveDown(3);

            doc
                .font("fonts/Asap-Regular.ttf")
                .fontSize(10)
                .fillColor("#111827")
                .text(`Date: ${acceptedAtDate.toLocaleDateString("en-IN", {
                    timeZone: "Asia/Kolkata",
                })}`, {
                    width: colWidth,
                })
                .moveDown(0.3);

            doc.text(`Place: ${city}`, {
                width: colWidth,
            });

            doc.moveDown(2);

            // Digital acceptance details block
            if (signer) {
                doc
                    .moveDown(1.0)
                    .font("fonts/Asap-Bold.ttf")
                    .fontSize(11)
                    .fillColor("#111827")
                    .text("Digital Acceptance Details", {
                        width: pageWidth,
                    })
                    .moveDown(0.4);

                doc
                    .font("fonts/Asap-Regular.ttf")
                    .fontSize(9.5)
                    .fillColor("#111827")
                    .text(
                        `Accepted by: ${signer.name}${signer.email ? ` <${signer.email}>` : ""}`,
                        { width: pageWidth }
                    );

                doc.text(
                    `Accepted on: ${acceptedAtDate.toLocaleString("en-IN", {
                        timeZone: "Asia/Kolkata",
                    })}`,
                    { width: pageWidth }
                );

                if (signer.ip) {
                    doc.text(`IP address at time of acceptance: ${signer.ip}`, {
                        width: pageWidth,
                    });
                }

                doc.moveDown(0.8);
            }

            doc
                .font("fonts/Asap-Regular.ttf")
                .fontSize(9)
                .fillColor("#4B5563")
                .text(
                    "Note: Where this agreement is accepted digitally through the 99Squarewall app / web link, the electronic acceptance record (including timestamp, IP address and user identity) maintained by 99Squarewall shall be treated as valid evidence of consent and shall be considered equivalent to physical signatures for the purposes of this agreement.",
                    {
                        width: pageWidth,
                        align: "justify",
                    }
                );
        }

        // ==========================================================
        // PAGE 1 â€“ AGREEMENT PAGE (styled like screenshot)
        // ==========================================================

        // MAIN HEADING
        doc
            .font("fonts/Asap-Bold.ttf")
            .fontSize(14.5)
            .text("AGREEMENT FOR CONSTRUCTION OF BUILDING", {
                align: "center",
                width: pageWidth,
            })
            .moveDown(0.8);

        // Sub-heading line
        doc
            .font("fonts/Asap-Regular.ttf")
            .fontSize(11.5)
            .text(`THIS AGREEMENT FOR CONSTRUCTION OF HOUSE made and executed at ${city} on this date ${agreementDate}`,
                { align: "center", }
            )
            .font("fonts/Asap-Regular.ttf")
            .moveDown(1.4);

        // BY AND BETWEEN
        doc
            .font("fonts/Asap-Bold.ttf")
            .fontSize(11.5)
            .text("BY and BETWEEN", { marginLeft: -20, align: "center" })
            .moveUp(1)
            .moveDown(2);

        // OWNER DETAILS
        doc
            .font("fonts/Asap-Regular.ttf")
            .fontSize(11)
            .text("1. ", { continued: true })
            .font("fonts/Asap-Bold.ttf")
            .text(`${clientName}`, { continued: true })
            .font("fonts/Asap-Regular.ttf")
            .text(
                `, Occupation: __________________ , R/at: ${siteAddress || "__________________"}.`,
                { align: "left", width: pageWidth }
            )
            .moveDown(0.5);

        doc
            .font("fonts/Asap-Regular.ttf")
            .fontSize(9.5)
            .text(
                '(hereinafter called as "OWNER", which expression, unless repugnant to the context or meaning thereof, shall include his/her legal heirs, assigns and successors.)',
                { align: "left", width: pageWidth }
            )
            .moveDown(1.2);

        // CONTRACTOR DETAILS
        doc
            .font("fonts/Asap-Bold.ttf")
            .fontSize(11)
            .text("AND", { align: "center" })
            .moveDown(0.7);

        doc
            .font("fonts/Asap-Regular.ttf")
            .fontSize(11)
            .text("1. ", { continued: true })
            .font("fonts/Asap-Bold.ttf")
            .text("99Squarewall Home Construction Company", { continued: true })
            .font("fonts/Asap-Regular.ttf")
            .text(
                ", having its registered office at Office C-213, 2nd Floor, Gravity Commercial Complex, Behind Mitcon, Balewadi, Pune â€“ 411045, through its Authorized Signatory.",
                { align: "left", width: pageWidth }
            )
            .moveDown(1);

        doc
            .font("fonts/Asap-Regular.ttf")
            .fontSize(9.5)
            .text(
                '(hereinafter called as "BUILDING CONTRACTOR", which expression, unless repugnant to the context or meaning thereof, shall include its legal heirs, assigns and successors.)',
                { align: "left", width: pageWidth }
            )
            .moveDown(1.5);

        // WHEREAS
        const plotDesc = areaOfPlot
            ? `${areaOfPlot} sq.ft residential plot located at ${siteAddress || "__________________"}`
            : `a residential plot located at ${siteAddress || "__________________"}`;

        doc
            .font("fonts/Asap-Bold.ttf")
            .fontSize(11)
            .text("WHEREAS", { align: "left" })
            .moveDown(0.25);

        doc
            .font("fonts/Asap-Regular.ttf")
            .fontSize(10.5)
            .text(
                `The OWNER possesses a plot of land bearing the above-mentioned details, more particularly described as ${plotDesc}. The OWNER is desirous of constructing a house on the said plot of land as per the approved architectural and structural drawings and as per the items, specifications, rates and quantities annexed hereto and forming part of this agreement.`,
                { align: "justify", width: pageWidth }
            )
            .moveDown(1.8);

        // NOW THIS AGREEMENT IS AS FOLLOWS
        doc
            .font("fonts/Asap-Bold.ttf")
            .fontSize(11)
            .text("NOW, THIS AGREEMENT IS AS FOLLOWS:", {
                align: "left",
            })
            .moveDown(0.5);

        // Total cost line (with bold amount)
        doc
            .font("fonts/Asap-Regular.ttf")
            .fontSize(10.5)
            .text("The total cost for construction of the building is fixed at ", {
                continued: true,
            })
            .font("fonts/Asap-Bold.ttf")
            .text(`Rs.${contractValueInr}/- `, { continued: true })
            .font("fonts/Asap-Regular.ttf")
            .text(
                " (Rupees Eighty Six Lakh Sixty Seven Thousand Eight Hundred Rupees only â€“ or as per final approved estimate) towards carrying out the work in respect of the complete construction of the said building, as per the approved drawings, specifications and mutually agreed terms.",
                { width: pageWidth }
            )
            .moveDown(0.6);

        doc
            .font("fonts/Asap-Regular.ttf")
            .fontSize(10.5)
            .text(
                "Any additional work other than what is covered in the approved drawings, items, rates and specifications under this agreement shall be executed and charged separately as per the rates mutually decided by both the parties at the time of such additional work.",
                { align: "justify", width: pageWidth }
            )
            .moveDown(0.6);

        doc
            .font("fonts/Asap-Regular.ttf")
            .fontSize(10.5)
            .text(
                "The agreed construction rate shall remain constant for up to 5% variation in the market rate of major materials. Any variation beyond this 5% shall be discussed and decided with mutual understanding between the OWNER and the BUILDING CONTRACTOR.",
                { align: "justify", width: pageWidth }
            )
            .moveDown(1.2);

        // CONDITIONS & SPECIFICATIONS START (heading at bottom of page 1)
        // doc
        //     .font("fonts/Asap-Bold.ttf")
        //     .fontSize(11)
        //     .text("FOLLOWING ARE THE CONDITIONS & SPECIFICATIONS:", {
        //         align: "left",
        //     })
        //     .moveDown(0.5);

        // You can either start the first point here or let the detailed
        // conditions continue on the next page(s).

        // ================================
        // PAGE 2 â€“ TERMS & CONDITIONS
        // ================================
        renderTermsAndConditionsPage();

        // ================================
        // PAGE 3 â€“ ACCEPTANCE & SIGNATURE (OWNER)
        // ================================
        renderAcceptancePage();

        // ================================
        // FINAL PAGE â€“ SUMMARY & SIGNATURE INFO
        // ================================
        // doc.addPage({ margin: 60 });

        // const title =
        //     project.projectTitle ||
        //     project.projectName ||
        //     project.projectId ||
        //     "";

        // doc
        //     .font("fonts/Asap-Bold.ttf")
        //     .fontSize(15)
        //     .text("Project Summary & Digital Acceptance", { align: "center" })
        //     .moveDown(1.4);

        // doc
        //     .font("fonts/Asap-Regular.ttf")
        //     .fontSize(11.5)
        //     .text(`Project: ${title}`, { width: pageWidth });
        // doc.text(`Project ID: ${project.projectId || ""}`);
        // doc.text(`Configuration: ${configurationName}`);
        // doc.text(`Plot Area: ${areaOfPlot || "As per approved estimate"}`);
        // doc.text(`Site Address: ${siteAddress}`);
        // doc.text(`Total Contract Value: â‚¹${contractValueInr}/-`);
        // doc.moveDown(1.4);

        // ... rest of your "Digital Signature Details" block as-is ...

        // ===== finalize =====
        doc.end();

        stream.on("finish", () => {
            const base = "http://localhost:8080/"; // or your env base
            const normalizedBase = base.replace(/\/+$/, "");
            const publicPath = `/agreements/${fileName}`;
            const publicUrl = normalizedBase
                ? `${normalizedBase}${publicPath}`
                : publicPath;

            resolve({ filePath, publicUrl });
        });

        stream.on("error", reject);
    });
}

/**
 * POST /api/public/agreement/accept
 *
 * Body: { token, projectId, signerName, signerEmail, acceptTerms, signatureData? }
 */
export const acceptAgreement = async (req, res) => {
    try {
        const {
            token,
            projectId,
            signerName,
            signerEmail,
            acceptTerms,
            signatureData, // optional: base64 image, etc.
        } = req.body;

        if (!token || !projectId) {
            return res
                .status(400)
                .json({ ok: false, message: "Missing token or projectId." });
        }

        if (!acceptTerms) {
            return res.status(400).json({
                ok: false,
                message: "You must confirm that you accept the agreement terms.",
            });
        }

        if (!signatureData) {
            return res.status(400).json({
                ok: false,
                message: "Signature is required to accept the agreement.",
            });
        }

        const project = await Project.findOne({
            _id: projectId,
            "agreement.token": token,
        })
            .populate("clientId")
            .populate("estimateId");

        if (!project) {
            return res
                .status(404)
                .json({ ok: false, message: "Agreement not found or link is invalid." });
        }

        // Already accepted?
        if (project.agreement?.acceptedAt) {
            return res.status(400).json({
                ok: false,
                code: "ALREADY_ACCEPTED",
                message: "This agreement has already been accepted.",
            });
        }

        const client = project.clientId;   // User doc
        const estimate = project.estimateId || null;

        const ip =
            (req.headers["x-forwarded-for"] || "")
                .split(",")[0]
                .trim() || req.ip;
        const userAgent = req.headers["user-agent"] || "";

        const signer = {
            name:
                signerName ||
                client?.fullName ||
                client?.name ||
                client?.username ||
                "Client",
            email: signerEmail || client?.email || "",
            ip,
        };

        const acceptedAt = new Date();

        // 1) Generate signed agreement PDF
        const { publicUrl, filePath } = await generateSignedAgreementPdf({
            project,
            client,
            signer,
            estimate,
            signatureData,
            acceptedAt,
        });

        // 2) Update project
        project.agreement.acceptedAt = acceptedAt;
        project.agreement.signedPdfUrl = publicUrl;
        project.agreement.signedByName = signer.name;
        project.agreement.signedByEmail = signer.email;
        project.agreement.signedFromIp = ip;
        project.agreement.acceptedFromUserAgent = userAgent;

        project.status = "project_started";
        project.startProject = true;
        project.updatedAt = new Date();

        await project.save();

        // 3) (Optional) ensure estimate is marked approved (don't change enum)
        if (estimate && estimate.status !== "approved") {
            estimate.status = "approved";
            await estimate.save();
        }

        // 4) Update User (client) â€“ start project, move to Construction KickOff
        if (client) {
            client.startProject = true;
            client.currentPhase = "Construction KickOff";

            if (Array.isArray(client.steps)) {
                const agrIndex = client.steps.findIndex(
                    (s) => s.title === "Agreement & booking payment"
                );
                const preIndex = client.steps.findIndex(
                    (s) => s.title === "Pre-construction Readiness"
                );

                if (agrIndex !== -1) {
                    client.steps[agrIndex].status = "completed";
                }
                if (preIndex !== -1 && !client.steps[preIndex].status) {
                    client.steps[preIndex].status = "ongoing-stage";
                }
            }

            // Align constructionDetails row (for this estimate/project)
            if (Array.isArray(client.constructionDetails)) {
                const cd = client.constructionDetails.find(
                    (c) =>
                        (project.estimateId &&
                            c.estimateId?.toString?.() ===
                            project.estimateId.toString()) ||
                        (estimate && c.estimateHumanId === estimate.humanId)
                );
                if (cd) {
                    cd.stage = "Agreement accepted";
                    cd.status = "Project Started";
                    if (typeof cd.approved !== "undefined") cd.approved = true;
                    if (typeof cd.finalApproved !== "undefined") cd.finalApproved = true;
                }
            }

            await client.save();
        }

        // 5) Email signed agreement & project start confirmation to client
        try {
            if (client?.email) {
                const contractValueNumber = Number(
                    project.contractValue || project.totalAmount || 0
                );
                const contractValueInr = contractValueNumber
                    ? contractValueNumber.toLocaleString("en-IN")
                    : "â€”";

                const subject = `99Squarewall | Agreement signed & project started (${project.projectId || project._id})`;

                const html = `
                    <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; font-size: 15px; color: #111827; line-height: 1.6;">
                        <p>Hi ${signer.name},</p>

                        <p>
                            Thank you for confirming your agreement with <strong>99Squarewall</strong>.
                            Your agreement has been <strong>successfully signed</strong> and your project
                            is now marked as <strong>Project Started</strong> in our system.
                        </p>

                        <div style="margin: 16px 0; padding: 14px 16px; background:#F3F4FF; border-radius: 10px; border:1px solid #E0E3FF;">
                            <div style="font-weight:600; margin-bottom:8px;">Project Summary</div>
                            <table style="width:100%; font-size:14px; border-collapse:collapse;">
                                <tr>
                                    <td style="padding:4px 0; width:38%; color:#4B5563;">Project ID</td>
                                    <td style="padding:4px 0;">${project.projectId || ""}</td>
                                </tr>
                                <tr>
                                    <td style="padding:4px 0; color:#4B5563;">Project Title</td>
                                    <td style="padding:4px 0;">${project.projectTitle || ""}</td>
                                </tr>
                                <tr>
                                    <td style="padding:4px 0; color:#4B5563;">Site Address</td>
                                    <td style="padding:4px 0;">${project.siteAddress || project.plotInformation?.plotLocation || ""}</td>
                                </tr>
                                <tr>
                                    <td style="padding:4px 0; color:#4B5563;">Total Contract Value</td>
                                    <td style="padding:4px 0;">â‚¹ ${contractValueInr}/-</td>
                                </tr>
                                <tr>
                                    <td style="padding:4px 0; color:#4B5563;">Current Status</td>
                                    <td style="padding:4px 0;">${project.status || "project_started"}</td>
                                </tr>
                            </table>
                        </div>

                        <p>
                            A copy of your <strong>signed agreement</strong> is attached with this email
                            for your records. You can also access it later from your 99Squarewall client
                            dashboard / app.
                        </p>

                        <p style="margin-top:16px;">
                            Our team will now proceed with <strong>Pre-construction Readiness</strong> and
                            share the detailed work schedule, site readiness checklist and further steps.
                        </p>

                        <p style="margin-top: 16px;">
                            Warm regards,<br/>
                            <strong>99Squarewall</strong><br/>
                            Home Construction Company
                        </p>
                    </div>
                `;

                const text = `
Hi ${signer.name},

Your construction agreement with 99Squarewall has been successfully signed and your project is now marked as "Project Started" in our system.

Project ID: ${project.projectId || project._id}
Project Title: ${project.projectTitle || ""}
Site Address: ${project.siteAddress || project.plotInformation?.plotLocation || ""}
Total Contract Value: â‚¹${contractValueInr}/-
Current Status: ${project.status || "project_started"}

A copy of the signed agreement PDF is attached to this email for your records.

Our team will now proceed with Pre-construction Readiness and share the detailed work schedule and next steps.

Warm regards,
99Squarewall
Home Construction Company
                `.trim();

                let attachments = [];

                try {
                    // Load the generated PDF file
                    const content = await fs.promises.readFile(filePath);
                    attachments.push({
                        filename: `99Squarewall_Agreement_${project.projectId || project._id}.pdf`,
                        content,
                        contentType: "application/pdf",
                    });
                } catch (e) {
                    console.warn(
                        "acceptAgreement: failed to read signed PDF for email attachment",
                        e
                    );
                }

                await sendMailWithAttachments({
                    to: client.email,
                    subject,
                    html,
                    text,
                    attachments,
                });
            }
        } catch (e) {
            console.warn("acceptAgreement: failed to send project-start email", e);
        }

        // 5) Activity log
        try {
            await logActivity(project, {
                type: "agreement.accepted",
                name: "Agreement Accepted",
                description: `Agreement signed by ${signer.name}`,
                actor: { name: signer.name, actorType: "client" },
                meta: {
                    signerEmail: signer.email,
                    ip,
                },
            });
        } catch (e) {
            console.warn("acceptAgreement: failed to log activity", e);
        }

        return res.json({
            ok: true,
            message: "Agreement accepted. Project has been marked as started.",
            data: {
                projectId: project._id,
                status: project.status,
                signedPdfUrl: publicUrl,
            },
        });
    } catch (err) {
        console.error("acceptAgreement error:", err);
        return res.status(500).json({
            ok: false,
            message: "Something went wrong while accepting the agreement.",
        });
    }
};
